<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroPuzzle | Adaptive Brain Teaser</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ§ </text></svg>">
    
    <style>
        /* ===== CSS RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Primary Colors */
            --primary-color: #7b61ff;
            --primary-dark: #6749ff;
            --primary-light: #9d8aff;
            --secondary-color: #00ffcc;
            --accent-color: #ff00ff;
            --warning-color: #ffd166;
            --error-color: #ff6b6b;
            --success-color: #06d6a0;
            
            /* Background Colors */
            --background-dark: #0f0f2f;
            --background-darker: #06060a;
            --background-card: rgba(30, 30, 46, 0.9);
            --background-card-solid: #1a1a2e;
            
            /* Text Colors */
            --text-light: #ffffff;
            --text-muted: #bbbbbb;
            --text-gray: #888888;
            
            /* UI Colors */
            --border-color: rgba(123, 97, 255, 0.3);
            --shadow-light: rgba(123, 97, 255, 0.2);
            --shadow-dark: rgba(0, 0, 0, 0.5);
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            --gradient-secondary: linear-gradient(135deg, var(--secondary-color), #00cc99);
            
            /* Spacing */
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            
            /* Transitions */
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background-darker);
            color: var(--text-light);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 0;
            margin: 0;
        }

        /* ===== TYPOGRAPHY ===== */
        h1, h2, h3, h4 {
            font-weight: 600;
            line-height: 1.2;
        }

        h1 { font-size: 2.5rem; }
        h2 { font-size: 2rem; }
        h3 { font-size: 1.5rem; }

        .app-tagline {
            font-size: 1rem;
            color: var(--text-muted);
            font-weight: 300;
        }

        .highlight {
            color: var(--secondary-color);
        }

        /* ===== LAYOUT & CONTAINERS ===== */
        #app-container {
            display: none;
            flex-direction: column;
            min-height: 100vh;
            padding: var(--spacing-sm);
        }

        #mode-panel {
            display: flex;
            min-height: 100vh;
            background: var(--background-darker);
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
        }

        /* ===== HEADER ===== */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--background-card);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-md);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px var(--shadow-dark);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .neuro-icon {
            font-size: 2rem;
            margin-right: var(--spacing-xs);
            color: var(--primary-color);
        }

        /* ===== USER INFO STYLES ===== */
        .user-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: rgba(123, 97, 255, 0.1);
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: 50px;
            border: 1px solid var(--border-color);
        }

        #user-avatar, #mode-user-avatar {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            color: var(--text-light);
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        #user-name, #mode-user-name {
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        #user-status {
            font-size: 0.8rem;
            color: var(--secondary-color);
        }

        .logout-btn {
            background: transparent;
            border: 1px solid rgba(255, 107, 107, 0.3);
            color: var(--error-color);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-normal);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .logout-btn:hover {
            background: rgba(255, 107, 107, 0.1);
        }

        /* ===== STATS CONTAINER ===== */
        .stats-container {
            display: flex;
            gap: var(--spacing-md);
            background: rgba(30, 30, 46, 0.8);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 70px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--secondary-color);
        }

        /* ===== BUTTONS ===== */
        .icon-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-normal);
            font-size: 1rem;
        }

        .icon-btn:hover {
            background: rgba(123, 97, 255, 0.2);
            transform: translateY(-2px);
        }

        .pause-btn {
            background: rgba(255, 209, 102, 0.1);
            border-color: rgba(255, 209, 102, 0.3);
        }

        .pause-btn:hover {
            background: rgba(255, 209, 102, 0.2);
        }

        .btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-md);
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            justify-content: center;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: var(--text-light);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px var(--shadow-light);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-warning {
            background: rgba(255, 209, 102, 0.2);
            color: #ffd166;
            border: 1px solid rgba(255, 209, 102, 0.3);
        }

        /* ===== GAME AREA ===== */
        .game-area {
            display: flex;
            gap: var(--spacing-md);
            flex: 1;
        }

        .puzzle-container {
            flex: 2;
            background: var(--background-card);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 40px var(--shadow-dark);
        }

        .puzzle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .puzzle-meta {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .puzzle-type {
            font-weight: 500;
            color: var(--text-light);
        }

        .difficulty-badge {
            background: rgba(123, 97, 255, 0.2);
            color: var(--primary-light);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .puzzle-stats {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .session-time {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .timer {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            color: var(--secondary-color);
        }

        /* ===== PUZZLE CONTENT ===== */
        .puzzle-content {
            background: rgba(30, 30, 46, 0.7);
            border-radius: var(--radius-md);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--border-color);
        }

        .welcome-message {
            text-align: center;
        }

        .welcome-message h3 {
            margin-bottom: var(--spacing-sm);
            color: var(--secondary-color);
        }

        .welcome-message p {
            color: var(--text-muted);
        }

        /* ===== PUZZLE CONTROLS ===== */
        .puzzle-controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: var(--spacing-md);
        }

        .hint-section {
            flex: 1;
            max-width: 300px;
        }

        .hint-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .hint-display, #explanation-display {
            margin-top: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: rgba(0, 255, 204, 0.1);
            border-radius: var(--radius-sm);
            border: 1px solid rgba(0, 255, 204, 0.2);
            color: var(--secondary-color);
            font-size: 0.9rem;
            display: none;
        }

        #explanation-display {
            background: rgba(123, 97, 255, 0.1);
            border: 1px solid var(--border-color);
            color: var(--primary-light);
        }

        .answer-section {
            flex: 2;
        }

        .input-group {
            display: flex;
            gap: var(--spacing-sm);
        }

        #answer-input {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-light);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
        }

        #answer-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(123, 97, 255, 0.2);
        }

        .quick-answers {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .quick-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-normal);
            font-size: 0.9rem;
            font-family: 'Inter', sans-serif;
        }

        .quick-btn:hover {
            background: rgba(123, 97, 255, 0.2);
            color: var(--text-light);
        }

        /* ===== SIDE PANEL ===== */
        .side-panel {
            flex: 1;
            max-width: 350px;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .panel-section {
            background: var(--background-card);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            border: 1px solid var(--border-color);
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            color: var(--text-light);
            font-size: 1.1rem;
        }

        .progress-chart {
            margin-bottom: var(--spacing-md);
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: var(--spacing-xs);
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 4px;
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
        }

        .progress-stat {
            text-align: center;
            padding: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
        }

        .stat-name {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .stat-number {
            display: block;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--secondary-color);
        }

        /* ===== DAILY CHALLENGE ===== */
        .daily-challenge {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .challenge-title {
            font-weight: 500;
            color: var(--text-light);
        }

        .challenge-reward {
            background: rgba(255, 209, 102, 0.2);
            color: #ffd166;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .challenge-desc {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: var(--spacing-sm);
        }

        .challenge-progress {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .challenge-progress .progress-bar {
            flex: 1;
        }

        .challenge-time {
            font-size: 0.8rem;
            color: var(--text-gray);
            white-space: nowrap;
        }

        .btn-challenge {
            width: 100%;
            margin-top: var(--spacing-sm);
            background: rgba(123, 97, 255, 0.1);
            color: var(--primary-light);
            border: 1px solid var(--border-color);
        }

        .btn-challenge:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ===== RECENT PUZZLES ===== */
        .recent-puzzles {
            max-height: 200px;
            overflow-y: auto;
        }

        .recent-puzzle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-normal);
        }

        .recent-puzzle-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .puzzle-result {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .puzzle-result.correct {
            color: var(--success-color);
        }

        .puzzle-result.incorrect {
            color: var(--error-color);
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-lg);
            color: var(--text-muted);
            font-style: italic;
        }

        /* ===== MODAL OVERLAYS ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(6, 6, 10, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        #settings-modal {
            display: none;
        }

        .modal-content {
            background: var(--background-card);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 60px var(--shadow-dark);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--text-light);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition-normal);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
        }

        .modal-body {
            margin-bottom: var(--spacing-lg);
        }

        .setting-group {
            margin-bottom: var(--spacing-lg);
        }

        .setting-title {
            font-size: 1.1rem;
            color: var(--text-light);
            margin-bottom: var(--spacing-sm);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-label {
            color: var(--text-light);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: var(--transition-normal);
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: var(--text-light);
            transition: var(--transition-normal);
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* ===== PAUSE OVERLAY ===== */
        .pause-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(6, 6, 10, 0.9);
            backdrop-filter: blur(5px);
            border-radius: var(--radius-lg);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .pause-content {
            text-align: center;
            background: var(--background-card);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            max-width: 400px;
            width: 90%;
        }

        .pause-icon {
            font-size: 3rem;
            color: var(--warning-color);
            margin-bottom: var(--spacing-md);
        }

        .pause-title {
            font-size: 2rem;
            color: var(--text-light);
            margin-bottom: var(--spacing-sm);
        }

        .pause-text {
            color: var(--text-muted);
            margin-bottom: var(--spacing-lg);
        }

        .pause-actions {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: center;
        }

        /* ===== NOTIFICATION AREA ===== */
        .notification-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            max-width: 300px;
        }

        .notification {
            background: var(--background-card);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 20px var(--shadow-dark);
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            position: relative;
        }

        .notification.success {
            border-left: 4px solid var(--success-color);
        }

        .notification.error {
            border-left: 4px solid var(--error-color);
        }

        .notification.info {
            border-left: 4px solid var(--primary-color);
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: var(--spacing-xs);
            margin-left: auto;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ===== HISTORY PANEL ===== */
        .history-panel-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(6, 6, 10, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .history-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 400px;
            height: 100%;
            background: var(--background-card);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 40px var(--shadow-dark);
        }

        .history-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .history-tab {
            flex: 1;
            padding: var(--spacing-md);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition-normal);
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
        }

        .history-tab:hover,
        .history-tab.active {
            color: var(--text-light);
            background: rgba(123, 97, 255, 0.1);
        }

        .history-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-lg);
        }

        .history-tab-content {
            display: none;
        }

        .history-tab-content.active {
            display: block;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .history-item {
            padding: var(--spacing-md);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition-normal);
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .history-item.correct {
            border-left: 4px solid var(--success-color);
        }

        .history-item.incorrect {
            border-left: 4px solid var(--error-color);
        }

        .history-question {
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
            color: var(--text-light);
        }

        .history-result {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-xs);
        }

        .history-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            padding: var(--spacing-md);
            text-align: center;
        }

        .stat-card .stat-title {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: var(--spacing-xs);
        }

        .stat-card .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .stat-card .stat-value.correct {
            color: var(--success-color);
        }

        .stat-card .stat-value.incorrect {
            color: var(--error-color);
        }

        .chart-container {
            height: 150px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            padding: var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-style: italic;
        }

        /* ===== MODE SELECTION PANEL ===== */
        .mode-selection-container {
            background: var(--background-card);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            width: 90%;
            max-width: 1000px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 60px var(--shadow-dark);
            max-height: 90vh;
            overflow-y: auto;
        }

        .mode-header {
            text-align: center;
            margin-bottom: var(--spacing-lg);
        }

        .mode-header h2 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: var(--spacing-xs);
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .mode-header p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .user-info-display {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            background: rgba(123, 97, 255, 0.1);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .user-avatar-mode {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--text-light);
        }

        .user-details-mode {
            flex: 1;
        }

        .user-name-mode {
            font-weight: 600;
            color: var(--text-light);
            display: block;
            font-size: 1.1rem;
        }

        .user-level-mode {
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        .progress-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }

        .progress-item {
            text-align: center;
            padding: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
        }

        .progress-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--secondary-color);
            display: block;
        }

        .progress-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: block;
            margin-top: var(--spacing-xs);
        }

        .mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .mode-card {
            background: rgba(30, 30, 46, 0.9);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            cursor: pointer;
            transition: var(--transition-normal);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .mode-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: 0 10px 30px var(--shadow-light);
        }

        .mode-card.active {
            border-color: var(--secondary-color);
            background: rgba(123, 97, 255, 0.1);
        }

        .mode-icon {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-sm);
            color: var(--primary-color);
        }

        .mode-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            color: var(--text-light);
        }

        .mode-desc {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: var(--spacing-sm);
            line-height: 1.4;
        }

        .mode-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-top: var(--spacing-sm);
        }

        .mode-tag {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--secondary-color);
            color: var(--background-darker);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .mode-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-md);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-start-game {
            background: var(--gradient-primary);
            color: var(--text-light);
            border: none;
            padding: var(--spacing-md) var(--spacing-xl);
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
            font-family: 'Inter', sans-serif;
        }

        .btn-start-game:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px var(--shadow-light);
        }

        /* ===== CURRENT MODE DISPLAY ===== */
        .current-mode-display {
            background: linear-gradient(90deg, rgba(123, 97, 255, 0.1), rgba(0, 255, 204, 0.1));
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 50px;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-right: var(--spacing-md);
            border: 1px solid var(--border-color);
        }

        .current-mode-text {
            color: var(--text-light);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .change-mode-btn {
            background: transparent;
            border: 1px solid rgba(123, 97, 255, 0.5);
            color: var(--primary-color);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition-normal);
            font-family: 'Inter', sans-serif;
        }

        .change-mode-btn:hover {
            background: rgba(123, 97, 255, 0.1);
        }

        /* ===== ANIMATIONS ===== */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-up {
            animation: slideUp 0.3s ease;
        }

        /* ===== ERROR MESSAGE ===== */
        .error-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: var(--spacing-lg);
        }

        .error-content {
            background: var(--background-card);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            border: 1px solid var(--error-color);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .error-content h3 {
            color: var(--error-color);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        .error-content p {
            margin-bottom: var(--spacing-lg);
            color: var(--text-muted);
        }

        .error-buttons {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
        }

        /* ===== CATEGORIES LIST ===== */
        .category-item {
            padding: var(--spacing-md);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            margin-bottom: var(--spacing-sm);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .category-name {
            font-weight: 500;
            color: var(--text-light);
            font-size: 1rem;
        }

        .category-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: block;
            margin-bottom: 2px;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: 600;
            color:#fcfefd;
            display: block;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1200px) {
            .game-area {
                flex-direction: column;
            }
            
            .side-panel {
                max-width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .panel-section {
                flex: 1;
                min-width: 300px;
            }
        }

        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: var(--spacing-md);
                padding: var(--spacing-md);
            }
            
            .header-right {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .stats-container {
                order: -1;
                width: 100%;
                justify-content: center;
            }
            
            .puzzle-controls {
                flex-direction: column;
                gap: var(--spacing-md);
            }
            
            .hint-section {
                max-width: 100%;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .mode-grid {
                grid-template-columns: 1fr;
            }
            
            .progress-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .history-panel {
                width: 100%;
            }
            
            .mode-selection-container {
                padding: var(--spacing-md);
                max-height: 100vh;
                border-radius: 0;
            }
            
            #mode-panel {
                padding: 0;
                align-items: flex-start;
            }
        }

        @media (max-width: 480px) {
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
            h3 { font-size: 1.2rem; }
            
            .app-header {
                padding: var(--spacing-sm);
            }
            
            .puzzle-container {
                padding: var(--spacing-md);
            }
            
            .mode-selection-container {
                padding: var(--spacing-md);
            }
            
            .modal-content {
                padding: var(--spacing-lg);
            }
            
            .progress-summary {
                grid-template-columns: 1fr;
            }
            
            .error-buttons {
                flex-direction: column;
            }
            
            .category-stats {
                grid-template-columns: 1fr;
                gap: var(--spacing-xs);
            }
        }

        /* ===== SCROLLBAR STYLING ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* ===== ATTEMPTS COUNTER ===== */
        #attempts-counter {
            color: var(--text-muted);
            font-size: 0.9rem;
            padding: var(--spacing-xs) var(--spacing-sm);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
        }
        
        /* ===== EXPLANATION DISPLAY ===== */
        #explanation-display {
            margin-top: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: rgba(123, 97, 255, 0.1);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            color: var(--primary-light);
            font-size: 0.9rem;
            display: none;
        }
        
        /* ===== SCROLLBAR STYLING ===== */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) rgba(255, 255, 255, 0.05);
        }

        /* Mobile Responsive */
@media (max-width: 768px) {
    .app-container {
        padding: 10px;
    }
    
    .header {
        flex-direction: column;
        gap: 10px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .mode-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .game-header {
        flex-wrap: wrap;
    }
    
    .quick-answers {
        flex-wrap: wrap;
    }
    
    .quick-btn {
        flex: 1 0 calc(50% - 10px);
        min-width: 0;
    }
    
    .modal-content {
        width: 90%;
        margin: 10% auto;
    }
}

/* Tablet Responsive */
@media (min-width: 769px) and (max-width: 1024px) {
    .mode-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .stats-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

/* Large Desktop */
@media (min-width: 1200px) {
    .container {
        max-width: 1200px;
        margin: 0 auto;
    }
}
/* Level Selector Styles */
.level-selector {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin: 15px 0;
}

.level-btn {
    padding: 8px 16px;
    border: 2px solid var(--border-color);
    border-radius: 20px;
    background: var(--card-bg);
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

.level-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.level-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: transparent;
}

.level-btn.completed {
    background: var(--success-color);
    color: white;
    border-color: transparent;
}

.level-btn.locked {
    opacity: 0.5;
    cursor: not-allowed;
}

/* AI Settings Styles */
.ai-settings {
    background: var(--card-bg);
    padding: 15px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
}

.setting-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
}

.setting-item:last-child {
    margin-bottom: 0;
}

.setting-item label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 500;
}

.setting-input {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--bg-color);
    color: var(--text-color);
    width: 100%;
}

.btn-small {
    padding: 6px 12px;
    font-size: 0.9em;
    margin-left: 10px;
}

/* AI Loading Indicator */
.ai-loading {
    display: none;
    text-align: center;
    padding: 20px;
}

.ai-loading.active {
    display: block;
}

.ai-loading .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-color);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
    </style>
</head>
<body>
    <!-- Mode Selection Panel (Shows first) -->
    <div class="user-mode-panel active" id="mode-panel">
        <div class="mode-selection-container">
            <div class="mode-header">
                <h2><span class="neuro-icon">ðŸ§ </span> NeuroPuzzle</h2>
                <p>Select your challenge mode. The AI adapts to your performance!</p>
            </div>
            
            <div class="user-info-display">
                <div class="user-avatar-mode" id="mode-user-avatar">U</div>
                <div class="user-details-mode">
                    <span class="user-name-mode" id="mode-user-name">Guest</span>
                    <span class="user-level-mode">IQ Score: <span id="mode-iq-score">100</span></span>
                </div>
            </div>
            
            <!-- Progress Summary -->
            <div class="progress-summary">
                <div class="progress-item">
                    <span class="progress-value" id="total-solved">0</span>
                    <span class="progress-label">Total Solved</span>
                </div>
                <div class="progress-item">
                    <span class="progress-value" id="current-streak">0</span>
                    <span class="progress-label">Day Streak</span>
                </div>
                <div class="progress-item">
                    <span class="progress-value" id="accuracy-rate">0%</span>
                    <span class="progress-label">Accuracy</span>
                </div>
                <div class="progress-item">
                    <span class="progress-value" id="best-level">1</span>
                    <span class="progress-label">Best Level</span>
                </div>
            </div>
            
            <div class="mode-grid" id="mode-grid">
                <!-- Modes will be populated by JavaScript -->
            </div>
            
            <div class="mode-footer">
                <button class="logout-btn" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                <button class="btn-start-game" id="start-game-btn">
                    <i class="fas fa-play"></i> Start Game
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div class="app-container" id="app-container" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <h1 class="app-title">
                    <span class="neuro-icon">ðŸ§ </span>
                    <span class="title-text">Neuro<span class="highlight">Puzzle</span></span>
                </h1>
                <p class="app-tagline">The more you play, the smarter it gets</p>
            </div>
            
            <div class="header-right">
                <!-- Current Mode Display -->
                <div class="current-mode-display">
                    <i class="fas fa-gamepad" id="current-mode-icon"></i>
                    <span class="current-mode-text" id="current-mode-name">Adaptive Mode</span>
                    <button class="change-mode-btn" id="change-mode-btn">Change</button>
                </div>
                
                <button class="icon-btn" id="history-tab-btn" aria-label="Answer History">
                    <i class="fas fa-history"></i>
                </button>
                
                <!-- User Info -->
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <div class="user-details">
                        <span class="user-name" id="user-name">Guest</span>
                        <span class="user-status" id="user-status">Ready</span>
                    </div>
                    <button class="logout-btn" id="header-logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
                
                <div class="stats-container">
                    <div class="stat-item">
                        <span class="stat-label">Streak</span>
                        <span class="stat-value" id="streak-counter">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Level</span>
                        <span class="stat-value" id="level-counter">1</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">IQ Score</span>
                        <span class="stat-value" id="iq-score">100</span>
                    </div>
                </div>
                
                <button class="icon-btn" id="settings-btn" aria-label="Settings">
                    <i class="fas fa-cog"></i>
                </button>
                
                <button class="icon-btn pause-btn" id="game-pause-btn" aria-label="Pause Game">
                    <i class="fas fa-pause"></i>
                </button>
            </div>
        </header>

        <!-- Main Game Area -->
        <main class="game-area">
            <!-- Pause Overlay -->
            <div class="pause-overlay" id="pause-overlay">
                <div class="pause-content">
                    <div class="pause-icon">
                        <i class="fas fa-pause"></i>
                    </div>
                    <h2 class="pause-title">Game Paused</h2>
                    <p class="pause-text">Take a break, your progress is saved.</p>
                    <div class="pause-actions">
                        <button class="btn btn-secondary" id="resume-btn">
                            <i class="fas fa-play"></i> Resume Game
                        </button>
                        <button class="btn btn-warning" id="end-session-btn">
                            <i class="fas fa-flag-checkered"></i> End Session
                        </button>
                        <button class="btn change-mode-btn" id="pause-change-mode">
                            <i class="fas fa-gamepad"></i> Change Mode
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Puzzle Container -->
            <div class="puzzle-container">
                <div class="puzzle-header">
                    <div class="puzzle-meta">
                        <span class="puzzle-type" id="puzzle-type">Pattern Recognition</span>
                        <span class="difficulty-badge" id="difficulty-badge">Medium</span>
                    </div>
                    <div class="puzzle-stats">
                        <div class="session-time">
                            <i class="fas fa-clock"></i>
                            <span class="timer" id="timer">00:00</span>
                        </div>
                        <span class="attempts" id="attempts-counter">Attempts: 0</span>
                    </div>
                </div>
                
                <div class="puzzle-content" id="puzzle-content">
                    <div class="welcome-message">
                        <h3>Welcome to NeuroPuzzle!</h3>
                        <p>Click "Start Game" to begin your first puzzle.</p>
                    </div>
                </div>
                
                <div class="puzzle-controls">
                    <div class="hint-section">
                        <button class="btn btn-secondary" id="hint-btn" disabled>
                            <i class="fas fa-lightbulb"></i> 
                            <span>Hint (<span id="hint-count">0</span> left)</span>
                        </button>
                        <div class="hint-display" id="hint-display"></div>
                        <div class="hint-display" id="explanation-display"></div>
                    </div>
                    
                    <div class="answer-section">
                        <div class="input-group">
                            <input type="text" id="answer-input" placeholder="Enter your answer..." autocomplete="off">
                            <button class="btn btn-primary" id="submit-btn">
                                <i class="fas fa-paper-plane"></i> Submit
                            </button>
                        </div>
                        <div class="quick-answers" id="quick-answers">
                            <!-- Quick answer buttons will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Side Panel -->
            <aside class="side-panel">
                <div class="panel-section">
                    <h3 class="panel-title">
                        <i class="fas fa-brain"></i> 
                        <span>Your Progress</span>
                    </h3>
                    <div class="progress-chart">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <div class="progress-labels">
                            <span>Today's Progress</span>
                            <span id="progress-percent">0%</span>
                        </div>
                    </div>
                    <div class="progress-stats">
                        <div class="progress-stat">
                            <span class="stat-name">Solved Today</span>
                            <span class="stat-number" id="solved-today">0</span>
                        </div>
                        <div class="progress-stat">
                            <span class="stat-name">Best Streak</span>
                            <span class="stat-number" id="best-streak">0</span>
                        </div>
                        <div class="progress-stat">
                            <span class="stat-name">Avg. Time</span>
                            <span class="stat-number" id="avg-time">0s</span>
                        </div>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3 class="panel-title">
                        <i class="fas fa-fire"></i> 
                        <span>Daily Challenge</span>
                    </h3>
                    <div class="daily-challenge">
                        <div class="challenge-header">
                            <span class="challenge-title">Prime Sequence</span>
                            <span class="challenge-reward">+50 IQ</span>
                        </div>
                        <p class="challenge-desc">Find the next prime in the hidden sequence</p>
                        <div class="challenge-progress">
                            <div class="progress-bar small">
                                <div class="progress-fill" id="challenge-progress"></div>
                            </div>
                            <span class="challenge-time" id="challenge-time">23h 59m left</span>
                        </div>
                        <button class="btn btn-challenge" id="daily-challenge-btn" disabled>
                            <i class="fas fa-lock"></i> 
                            <span>Unlocks in 3 puzzles</span>
                        </button>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3 class="panel-title">
                        <i class="fas fa-history"></i> 
                        <span>Recent Puzzles</span>
                    </h3>
                    <div class="recent-puzzles" id="recent-puzzles">
                        <div class="empty-state">No puzzles solved yet</div>
                    </div>
                </div>
            </aside>
        </main>
        
        <!-- Notification Area -->
        <div class="notification-area" id="notification-area"></div>
        
        <!-- Settings Modal -->
        <div class="modal-overlay" id="settings-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Settings</h2>
                    <button class="modal-close" id="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="setting-group">
                        <h3 class="setting-title">Game Settings</h3>
                        <div class="setting-item">
                            <label class="switch">
                                <input type="checkbox" id="sound-toggle" checked>
                                <span class="slider"></span>
                            </label>
                            <span class="setting-label">Sound Effects</span>
                        </div>
                        <div class="setting-item">
                            <label class="switch">
                                <input type="checkbox" id="animations-toggle" checked>
                                <span class="slider"></span>
                            </label>
                            <span class="setting-label">Animations</span>
                        </div>
                        <div class="setting-item">
                            <label class="switch">
                                <input type="checkbox" id="dark-mode-toggle" checked>
                                <span class="slider"></span>
                            </label>
                            <span class="setting-label">Dark Mode</span>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <h3 class="setting-title">Game Mode</h3>
                        <div class="setting-item">
                            <span class="setting-label">Current Mode</span>
                            <span class="setting-value" id="current-mode-display">Adaptive</span>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label">Adaptive AI</span>
                            <span class="setting-status active" id="ai-status">Active</span>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label">Current Level</span>
                            <span class="setting-value" id="current-level">1</span>
                        </div>
                        <button class="btn btn-secondary btn-small" id="reset-progress-btn">
                            Reset Progress
                        </button>
                        <button class="btn btn-secondary btn-small" id="change-mode-settings">
                            Change Game Mode
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Panel Overlay -->
        <div class="history-panel-overlay" id="history-panel-overlay" style="display: none;">
            <div class="history-panel">
                <div class="history-header">
                    <h3><i class="fas fa-history"></i> Answer History</h3>
                    <button class="history-close" id="history-close">&times;</button>
                </div>
                <div class="history-tabs">
                    <button class="history-tab active" data-tab="recent">Recent Answers</button>
                    <button class="history-tab" data-tab="stats">Statistics</button>
                    <button class="history-tab" data-tab="categories">Categories</button>
                </div>
                <div class="history-content">
                    <div class="history-tab-content active" id="recent-history">
                        <div class="history-list" id="history-list">
                            <div class="empty-state">No answers yet</div>
                        </div>
                    </div>
                    <div class="history-tab-content" id="stats-history">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-title">Total Answers</div>
                                <div class="stat-value" id="total-answers">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-title">Correct</div>
                                <div class="stat-value correct" id="correct-answers">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-title">Incorrect</div>
                                <div class="stat-value incorrect" id="incorrect-answers">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-title">Accuracy</div>
                                <div class="stat-value" id="accuracy-rate">100%</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-title">Avg. Time</div>
                                <div class="stat-value" id="avg-answer-time">0s</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-title">Best Streak</div>
                                <div class="stat-value" id="best-history-streak">0</div>
                            </div>
                        </div>
                        <div class="accuracy-chart">
                            <h4>Accuracy Trend (Last 7 Days)</h4>
                            <div class="chart-container" id="accuracy-chart">
                                <div class="empty-state">No data yet</div>
                            </div>
                        </div>
                    </div>
                    <div class="history-tab-content" id="categories-history">
                        <div class="categories-list" id="categories-list">
                            <div class="empty-state">No category data yet</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Level Selector -->
<div class="settings-section">
    <h3><i class="fas fa-chart-line"></i> Game Level</h3>
    <div id="level-selector" class="level-selector">
        <!-- Levels will be generated here -->
    </div>
</div>

<!-- AI Integration Section -->
<div class="settings-section">
    <h3><i class="fas fa-robot"></i> AI Integration</h3>
    <div class="ai-settings">
        <div class="setting-item">
            <label for="ai-enabled">
                <i class="fas fa-brain"></i> Enable AI Puzzles
            </label>
            <input type="checkbox" id="ai-enabled" class="toggle-switch">
        </div>
        <div class="setting-item" id="ai-api-section" style="display: none;">
            <label for="api-key">
                <i class="fas fa-key"></i> API Key
            </label>
            <input type="password" id="api-key" placeholder="Enter your API key" class="setting-input">
            <button id="save-api-key" class="btn btn-small">Save</button>
        </div>
        <div class="setting-item">
            <select id="ai-provider" class="setting-input">
                <option value="openai">OpenAI GPT</option>
                <option value="anthropic">Anthropic Claude</option>
                <option value="gemini">Google Gemini</option>
            </select>
        </div>
    </div>
</div>
    <!-- JavaScript Code -->
    <script>
// Define the app namespace
window.brainTeaserApp = {
    // Core modules
    currentUser: null,
    currentMode: null,
    currentDifficulty: 'medium', // easy, medium, hard
    userData: null,
    gameActive: false,
    timerInterval: null,
    sessionTime: 0,
    currentPuzzle: null,
    puzzleHistory: [],
    currentPuzzleAttempts: 0,
    lives: 3, // For survival mode
    maxTime: 300, // 5 minutes for timed mode
    timeLeft: 300, // For timed mode
    score: 0, // For timed and survival modes
    combo: 0, // Combo multiplier
    hintCount: 3, // Available hints per puzzle
    gamePaused: false,
    
    // Difficulty settings
    difficulties: [
        { 
            id: 'easy', 
            name: 'Easy', 
            color: '#4CAF50', 
            gradient: 'linear-gradient(135deg, #4CAF50, #8BC34A)',
            description: 'Great for beginners', 
            multiplier: 1,
            timeBonus: 1,
            icon: 'fas fa-seedling'
        },
        { 
            id: 'medium', 
            name: 'Medium', 
            color: '#FF9800', 
            gradient: 'linear-gradient(135deg, #FF9800, #FFB74D)',
            description: 'Balanced challenge', 
            multiplier: 2,
            timeBonus: 1.5,
            icon: 'fas fa-balance-scale'
        },
        { 
            id: 'hard', 
            name: 'Hard', 
            color: '#F44336', 
            gradient: 'linear-gradient(135deg, #F44336, #EF5350)',
            description: 'For experts only', 
            multiplier: 3,
            timeBonus: 2,
            icon: 'fas fa-fire'
        }
    ],
    
    // Game modes definition
    gameModes: [
        {
            id: 'adaptive',
            name: 'Adaptive AI',
            icon: 'fas fa-robot',
            description: 'AI adapts difficulty based on your performance',
            unlocked: true,
            features: ['Dynamic Difficulty', 'Personalized Puzzles', 'AI Learning'],
            stats: { puzzles: 0, bestLevel: 1, avgTime: 0 },
            bgColor: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
        },
        {
            id: 'timed',
            name: 'Timed Challenge',
            icon: 'fas fa-clock',
            description: 'Solve as many puzzles as possible in time limit',
            unlocked: true,
            features: ['Time Pressure', 'Speed Bonus', 'Leaderboards'],
            stats: { puzzles: 0, bestScore: 0, avgTime: 0 },
            bgColor: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'
        },
        {
            id: 'survival',
            name: 'Survival Mode',
            icon: 'fas fa-heart',
            description: 'Three lives - make three mistakes and game over',
            unlocked: true,
            features: ['Limited Lives', 'Combo Multipliers', 'High Risk High Reward'],
            stats: { puzzles: 0, bestStreak: 0, avgTime: 0 },
            bgColor: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
        },
        {
            id: 'math',
            name: 'Math Master',
            icon: 'fas fa-calculator',
            description: 'Focus on mathematical and logical puzzles',
            unlocked: true,
            features: ['Number Puzzles', 'Logic Problems', 'Pattern Recognition'],
            stats: { puzzles: 0, bestLevel: 1, avgTime: 0 },
            bgColor: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
        },
        {
            id: 'creative',
            name: 'Creative Thinking',
            icon: 'fas fa-lightbulb',
            description: 'Word games, riddles, and creative problem solving',
            unlocked: true,
            features: ['Riddles', 'Word Games', 'Lateral Thinking'],
            stats: { puzzles: 0, bestLevel: 1, avgTime: 0 },
            bgColor: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)'
        },
        {
            id: 'memory',
            name: 'Memory Training',
            icon: 'fas fa-brain',
            description: 'Improve your memory and concentration skills',
            unlocked: true,
            features: ['Memory Games', 'Focus Training', 'Recall Challenges'],
            stats: { puzzles: 0, bestLevel: 1, avgTime: 0 },
            bgColor: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
        },
        {
            id: 'visual',
            name: 'Visual Puzzles',
            icon: 'fas fa-eye',
            description: 'Pattern recognition and visual problem solving',
            unlocked: true,
            features: ['Pattern Puzzles', 'Visual Logic', 'Spatial Reasoning'],
            stats: { puzzles: 0, bestLevel: 1, avgTime: 0 },
            bgColor: 'linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)'
        },
        {
            id: 'mixed',
            name: 'Mixed Bag',
            icon: 'fas fa-random',
            description: 'Random puzzles from all categories',
            unlocked: true,
            features: ['Variety', 'All Categories', 'Surprise Elements'],
            stats: { puzzles: 0, bestLevel: 1, avgTime: 0 },
            bgColor: 'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)'
        }
    ],
    
    // Enhanced Puzzle types with more variety
    puzzleTypes: [
        {
            name: 'Number Sequence',
            description: 'Find the next number in the sequence',
            icon: 'fas fa-sort-numeric-up',
            generate: function(difficulty) {
                const sequences = {
                    easy: [
                        { sequence: [2, 4, 6, 8], answer: '10', explanation: 'Adding 2 each time' },
                        { sequence: [3, 6, 9, 12], answer: '15', explanation: 'Adding 3 each time' },
                        { sequence: [5, 10, 15, 20], answer: '25', explanation: 'Adding 5 each time' },
                        { sequence: [10, 20, 30, 40], answer: '50', explanation: 'Adding 10 each time' },
                        { sequence: [1, 2, 3, 4], answer: '5', explanation: 'Counting numbers' },
                        { sequence: [2, 4, 8, 16], answer: '32', explanation: 'Multiplying by 2 each time' },
                        { sequence: [100, 90, 80, 70], answer: '60', explanation: 'Subtracting 10 each time' },
                        { sequence: [1, 3, 5, 7], answer: '9', explanation: 'Odd numbers' },
                        { sequence: [2, 5, 8, 11], answer: '14', explanation: 'Adding 3 each time' },
                        { sequence: [10, 15, 20, 25], answer: '30', explanation: 'Adding 5 each time' }
                    ],
                    medium: [
                        { sequence: [1, 1, 2, 3, 5], answer: '8', explanation: 'Fibonacci sequence (each number is sum of previous two)' },
                        { sequence: [1, 4, 9, 16], answer: '25', explanation: 'Square numbers (1Â², 2Â², 3Â², 4Â², 5Â²)' },
                        { sequence: [2, 3, 5, 7], answer: '11', explanation: 'Prime numbers' },
                        { sequence: [1, 3, 6, 10], answer: '15', explanation: 'Triangular numbers (1, 1+2, 1+2+3, 1+2+3+4)' },
                        { sequence: [1, 8, 27, 64], answer: '125', explanation: 'Cube numbers (1Â³, 2Â³, 3Â³, 4Â³, 5Â³)' },
                        { sequence: [3, 9, 27, 81], answer: '243', explanation: 'Multiplying by 3 each time (powers of 3)' },
                        { sequence: [1, 2, 4, 7, 11], answer: '16', explanation: 'Adding 1, then 2, then 3, then 4, then 5' },
                        { sequence: [1, 2, 4, 8, 16], answer: '32', explanation: 'Powers of 2' },
                        { sequence: [2, 6, 12, 20], answer: '30', explanation: 'n Ã— (n+1): 1Ã—2, 2Ã—3, 3Ã—4, 4Ã—5, 5Ã—6' },
                        { sequence: [5, 9, 17, 33], answer: '65', explanation: 'Multiply by 2 and subtract 1: 5Ã—2-1=9, 9Ã—2-1=17, 17Ã—2-1=33, 33Ã—2-1=65' }
                    ],
                    hard: [
                        { sequence: [1, 4, 27, 256], answer: '3125', explanation: 'n to the power of n (1Â¹, 2Â², 3Â³, 4â´, 5âµ)' },
                        { sequence: [1, 2, 6, 24, 120], answer: '720', explanation: 'Factorials (1!, 2!, 3!, 4!, 5!, 6!)' },
                        { sequence: [1, 3, 7, 15, 31], answer: '63', explanation: '2â¿ - 1 (2Â¹-1, 2Â²-1, 2Â³-1, ...)' },
                        { sequence: [0, 1, 1, 2, 3, 5, 8], answer: '13', explanation: 'Fibonacci sequence starting with 0,1' },
                        { sequence: [2, 5, 10, 17, 26], answer: '37', explanation: 'nÂ² + 1 (1Â²+1, 2Â²+1, 3Â²+1, 4Â²+1, 5Â²+1, 6Â²+1)' },
                        { sequence: [1, 2, 4, 8, 16, 32], answer: '64', explanation: 'Powers of 2 (2â°, 2Â¹, 2Â², 2Â³, 2â´, 2âµ, 2â¶)' },
                        { sequence: [3, 4, 7, 11, 18, 29], answer: '47', explanation: 'Each number is the sum of the previous two' },
                        { sequence: [1, 4, 9, 18, 35], answer: '68', explanation: 'Multiply by 2 and add consecutive primes: 1Ã—2+2=4, 4Ã—2+1=9, 9Ã—2+0=18, 18Ã—2-1=35, 35Ã—2-2=68' },
                        { sequence: [2, 3, 10, 29, 66], answer: '127', explanation: 'nÂ³ + 1 (1Â³+1=2, 2Â³-1=3, 3Â³+1=10, 4Â³-1=29, 5Â³+1=66, 6Â³-1=127)' },
                        { sequence: [1, 11, 21, 1211, 111221], answer: '312211', explanation: 'Look-and-say sequence: describe the previous term' }
                    ]
                };
                
                const seq = sequences[difficulty][Math.floor(Math.random() * sequences[difficulty].length)];
                return {
                    question: `Find the next number: <span class="sequence">${seq.sequence.join(', ')}</span>`,
                    answer: seq.answer,
                    explanation: seq.explanation,
                    type: 'Number Sequence',
                    difficulty: difficulty,
                    hints: [
                        'Look for mathematical patterns',
                        'Check if it\'s arithmetic or geometric',
                        'Try adding, subtracting, or multiplying',
                        'Consider prime numbers or squares',
                        'Think about Fibonacci or factorials for hard puzzles'
                    ]
                };
            }
        },
        {
            name: 'Word Pattern',
            description: 'Complete the word pattern',
            icon: 'fas fa-font',
            generate: function(difficulty) {
                const patterns = {
                    easy: [
                        { pattern: 'CAT, DOG, RAT, ?', answer: 'COW', explanation: 'Common 3-letter animals' },
                        { pattern: 'RED, BLUE, GREEN, ?', answer: 'YELLOW', explanation: 'Primary and secondary colors' },
                        { pattern: 'RUN, WALK, JUMP, ?', answer: 'SKIP', explanation: 'Types of movement' },
                        { pattern: 'DAY, NIGHT, SUN, ?', answer: 'MOON', explanation: 'Related to time and celestial bodies' },
                        { pattern: 'UP, DOWN, LEFT, ?', answer: 'RIGHT', explanation: 'Directions' },
                        { pattern: 'HOT, COLD, FAST, ?', answer: 'SLOW', explanation: 'Opposites' },
                        { pattern: 'APPLE, ORANGE, BANANA, ?', answer: 'GRAPE', explanation: 'Fruits' },
                        { pattern: 'JANUARY, FEBRUARY, MARCH, ?', answer: 'APRIL', explanation: 'Months of the year' },
                        { pattern: 'MERCURY, VENUS, EARTH, ?', answer: 'MARS', explanation: 'Planets in order from the sun' },
                        { pattern: 'PENNY, NICKEL, DIME, ?', answer: 'QUARTER', explanation: 'US coins in increasing value' }
                    ],
                    medium: [
                        { pattern: 'BIG, SMALL, TALL, ?', answer: 'SHORT', explanation: 'Antonyms and size-related words' },
                        { pattern: 'HOT, COLD, WET, ?', answer: 'DRY', explanation: 'Opposite conditions' },
                        { pattern: 'SEE, HEAR, TOUCH, ?', answer: 'SMELL', explanation: 'The five senses' },
                        { pattern: 'EARTH, AIR, FIRE, ?', answer: 'WATER', explanation: 'Classical elements' },
                        { pattern: 'NORTH, SOUTH, EAST, ?', answer: 'WEST', explanation: 'Cardinal directions' },
                        { pattern: 'SPRING, SUMMER, FALL, ?', answer: 'WINTER', explanation: 'Seasons' },
                        { pattern: 'MERCURY, VENUS, EARTH, ?', answer: 'MARS', explanation: 'Planets in order from the sun' },
                        { pattern: 'READ, WRITE, SPEAK, ?', answer: 'LISTEN', explanation: 'Language skills' },
                        { pattern: 'ROSE, TULIP, DAISY, ?', answer: 'LILY', explanation: 'Flowers' },
                        { pattern: 'COPPER, SILVER, GOLD, ?', answer: 'PLATINUM', explanation: 'Precious metals in increasing value' }
                    ],
                    hard: [
                        { pattern: 'APPLE, BANANA, CHERRY, ?', answer: 'DATES', explanation: 'Alphabetical fruits (A, B, C, D)' },
                        { pattern: 'ONE, TWO, SIX, ?', answer: 'TEN', explanation: 'Number of letters (3, 3, 3, 3)' },
                        { pattern: 'JANUARY, MARCH, MAY, ?', answer: 'JULY', explanation: 'Months with 31 days' },
                        { pattern: 'VEHICLE, AIRPLANE, TRAIN, ?', answer: 'SHIP', explanation: 'Modes of transportation' },
                        { pattern: 'READ, WRITE, SPEAK, ?', answer: 'LISTEN', explanation: 'Language skills' },
                        { pattern: 'PENNY, NICKEL, DIME, ?', answer: 'QUARTER', explanation: 'US coins in increasing value' },
                        { pattern: 'MERCURY, VENUS, EARTH, MARS, ?', answer: 'JUPITER', explanation: 'Planets in order from the sun' },
                        { pattern: 'ALPHA, BETA, GAMMA, ?', answer: 'DELTA', explanation: 'Greek alphabet' },
                        { pattern: 'TEA, COFFEE, CHOCOLATE, ?', answer: 'WINE', explanation: 'Beverages with caffeine, then one without' },
                        { pattern: 'HEART, DIAMOND, CLUB, ?', answer: 'SPADE', explanation: 'Card suits' }
                    ]
                };
                
                const pattern = patterns[difficulty][Math.floor(Math.random() * patterns[difficulty].length)];
                return {
                    question: `Complete the pattern: <span class="pattern">${pattern.pattern}</span>`,
                    answer: pattern.answer,
                    explanation: pattern.explanation,
                    type: 'Word Pattern',
                    difficulty: difficulty,
                    hints: [
                        'Look for antonyms or synonyms',
                        'Think about categories',
                        'Consider word associations',
                        'Check the number of letters',
                        'Try alphabetical order or other patterns'
                    ]
                };
            }
        },
        {
            name: 'Logic Puzzle',
            description: 'Solve the logical reasoning problem',
            icon: 'fas fa-puzzle-piece',
            generate: function(difficulty) {
                const puzzles = {
                    easy: [
                        {
                            question: 'If all roses are flowers and some flowers fade quickly, are all roses fading quickly?',
                            answer: 'NO',
                            explanation: 'The statement says "some flowers fade quickly", not "all flowers fade quickly"',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What has keys but can\'t open locks?',
                            answer: 'PIANO',
                            explanation: 'A piano has keys but is a musical instrument',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'I speak without a mouth and hear without ears. I have no body, but I come alive with wind. What am I?',
                            answer: 'ECHO',
                            explanation: 'An echo repeats sounds without physical form',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What has a neck but no head?',
                            answer: 'BOTTLE',
                            explanation: 'A bottle has a neck but no head',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What gets wetter as it dries?',
                            answer: 'TOWEL',
                            explanation: 'A towel dries things but gets wet in the process',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What has hands but can\'t clap?',
                            answer: 'CLOCK',
                            explanation: 'Clock has hands (hour and minute) but can\'t clap',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What has an eye but cannot see?',
                            answer: 'NEEDLE',
                            explanation: 'A needle has an eye but cannot see',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What has a head, a tail, but no body?',
                            answer: 'COIN',
                            explanation: 'A coin has a head and tail but no body',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What comes once in a minute, twice in a moment, but never in a thousand years?',
                            answer: 'M',
                            explanation: 'The letter "M" appears once in "minute", twice in "moment", but not in "thousand years"',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What has many teeth but can\'t bite?',
                            answer: 'COMB',
                            explanation: 'A comb has teeth but can\'t bite',
                            type: 'Logic Puzzle'
                        }
                    ],
                    medium: [
                        {
                            question: 'A man builds a house with all four sides facing south. A bear walks by. What color is the bear?',
                            answer: 'WHITE',
                            explanation: 'Only at the North Pole can all sides face south. Polar bears are white.',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'The more you take, the more you leave behind. What am I?',
                            answer: 'FOOTSTEPS',
                            explanation: 'Footsteps are left behind as you walk',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What belongs to you but is used more by others?',
                            answer: 'NAME',
                            explanation: 'Your name is yours but others use it more often',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What has cities but no houses, forests but no trees, and water but no fish?',
                            answer: 'MAP',
                            explanation: 'A map shows these features but doesn\'t contain them',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What can you catch but not throw?',
                            answer: 'COLD',
                            explanation: 'You catch a cold, but you don\'t throw it',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What has words but never speaks?',
                            answer: 'BOOK',
                            explanation: 'A book has words but cannot speak',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'I\'m tall when I\'m young and short when I\'m old. What am I?',
                            answer: 'CANDLE',
                            explanation: 'A candle is tall when new and short when burned',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What has a thumb and four fingers but is not alive?',
                            answer: 'GLOVE',
                            explanation: 'A glove has finger spaces but is not alive',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What can travel around the world while staying in a corner?',
                            answer: 'STAMP',
                            explanation: 'A postage stamp stays in the corner of an envelope as it travels',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What has a ring but no finger?',
                            answer: 'TELEPHONE',
                            explanation: 'A telephone rings but has no finger',
                            type: 'Logic Puzzle'
                        }
                    ],
                    hard: [
                        {
                            question: 'If you have me, you want to share me. If you share me, you no longer have me. What am I?',
                            answer: 'SECRET',
                            explanation: 'Secrets lose their nature when shared',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'I am not alive, but I grow; I don\'t have lungs, but I need air; I don\'t have a mouth, but water kills me. What am I?',
                            answer: 'FIRE',
                            explanation: 'Fire grows, needs oxygen, and is extinguished by water',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'The person who makes it, sells it. The person who buys it never uses it. The person who uses it never knows they\'re using it. What is it?',
                            answer: 'COFFIN',
                            explanation: 'A coffin maker sells it, the buyer doesn\'t use it, and the user (dead) doesn\'t know',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What can run but never walks, has a mouth but never talks, has a head but never weeps, has a bed but never sleeps?',
                            answer: 'RIVER',
                            explanation: 'A river runs, has a mouth, headwaters, and a riverbed',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What goes through cities and fields but never moves?',
                            answer: 'ROAD',
                            explanation: 'A road goes through places but is stationary',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'I am always hungry, I must always be fed. The finger I touch will soon turn red. What am I?',
                            answer: 'FIRE',
                            explanation: 'Fire consumes fuel, and touching fire burns',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'What has keys that open no locks, space but no room, and you can enter but not go in?',
                            answer: 'KEYBOARD',
                            explanation: 'A keyboard has keys, space bar, and enter key but no physical spaces',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'I have branches but no fruit, trunk, or leaves. What am I?',
                            answer: 'BANK',
                            explanation: 'A bank has branches but is not a tree',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'The more of me you take, the more you leave behind. What am I?',
                            answer: 'FOOTSTEPS',
                            explanation: 'Footsteps are left behind as you walk',
                            type: 'Logic Puzzle'
                        },
                        {
                            question: 'I am always in front of you but cannot be seen. What am I?',
                            answer: 'FUTURE',
                            explanation: 'The future is always ahead but cannot be seen',
                            type: 'Logic Puzzle'
                        }
                    ]
                };
                
                const puzzle = puzzles[difficulty][Math.floor(Math.random() * puzzles[difficulty].length)];
                return {
                    question: puzzle.question,
                    answer: puzzle.answer.toUpperCase(),
                    explanation: puzzle.explanation,
                    type: puzzle.type,
                    difficulty: difficulty,
                    hints: [
                        'Think carefully about the logic',
                        'Consider all possibilities',
                        'Don\'t make assumptions',
                        'Read the question multiple times',
                        'Sometimes the answer is literal, sometimes metaphorical'
                    ]
                };
            }
        },
        {
            name: 'Math Puzzle',
            description: 'Solve the mathematical problem',
            icon: 'fas fa-calculator',
            generate: function(difficulty) {
                const puzzles = {
                    easy: [
                        { question: 'What is 15 + 27?', answer: '42', explanation: 'Simple addition: 15 + 27 = 42' },
                        { question: 'Multiply 8 by 7', answer: '56', explanation: '8 Ã— 7 = 56' },
                        { question: 'If you have 12 apples and give away 5, how many do you have left?', answer: '7', explanation: '12 - 5 = 7' },
                        { question: 'What is half of 50?', answer: '25', explanation: '50 Ã· 2 = 25' },
                        { question: 'How many sides does a hexagon have?', answer: '6', explanation: 'A hexagon has 6 sides' },
                        { question: 'What is 3 Ã— 4 + 5?', answer: '17', explanation: '3 Ã— 4 = 12, then 12 + 5 = 17' },
                        { question: 'What is the square of 9?', answer: '81', explanation: '9 Ã— 9 = 81' },
                        { question: 'What is 100 Ã· 4?', answer: '25', explanation: '100 Ã· 4 = 25' },
                        { question: 'What is 7 + 8 Ã— 2?', answer: '23', explanation: 'Multiplication first: 8 Ã— 2 = 16, then 7 + 16 = 23' },
                        { question: 'How many days are in a week?', answer: '7', explanation: 'There are 7 days in a week' }
                    ],
                    medium: [
                        { question: 'If 3x + 5 = 20, what is x?', answer: '5', explanation: '3x = 15, so x = 5' },
                        { question: 'What is the area of a rectangle with length 8 and width 5?', answer: '40', explanation: 'Area = length Ã— width = 8 Ã— 5 = 40' },
                        { question: 'What is 25% of 80?', answer: '20', explanation: '80 Ã— 0.25 = 20' },
                        { question: 'If a train travels 60 miles in 1 hour, how far will it travel in 2.5 hours?', answer: '150', explanation: '60 Ã— 2.5 = 150 miles' },
                        { question: 'What is the next prime number after 17?', answer: '19', explanation: 'Prime numbers: 2,3,5,7,11,13,17,19,...' },
                        { question: 'What is 15% of 200?', answer: '30', explanation: '200 Ã— 0.15 = 30' },
                        { question: 'What is 7Â² + 8?', answer: '57', explanation: '49 + 8 = 57' },
                        { question: 'What is 3/4 of 100?', answer: '75', explanation: '100 Ã— 3/4 = 75' },
                        { question: 'If a circle has radius 5, what is its diameter?', answer: '10', explanation: 'Diameter = 2 Ã— radius = 2 Ã— 5 = 10' },
                        { question: 'What is 2Â³ + 3Â²?', answer: '17', explanation: '2Â³ = 8, 3Â² = 9, 8 + 9 = 17' }
                    ],
                    hard: [
                        { question: 'What is the square root of 169?', answer: '13', explanation: '13 Ã— 13 = 169' },
                        { question: 'If xÂ² - 5x + 6 = 0, what are the possible values of x?', answer: '2,3', explanation: '(x-2)(x-3)=0, so x=2 or x=3' },
                        { question: 'What is the sum of angles in a triangle?', answer: '180', explanation: 'All triangles have interior angles summing to 180Â°' },
                        { question: 'If a circle has radius 7, what is its circumference? (Use Ï€=22/7)', answer: '44', explanation: 'Circumference = 2Ï€r = 2 Ã— (22/7) Ã— 7 = 44' },
                        { question: 'What is 7! (7 factorial)?', answer: '5040', explanation: '7! = 7Ã—6Ã—5Ã—4Ã—3Ã—2Ã—1 = 5040' },
                        { question: 'What is the cube root of 64?', answer: '4', explanation: '4 Ã— 4 Ã— 4 = 64' },
                        { question: 'What is 3â´?', answer: '81', explanation: '3 Ã— 3 Ã— 3 Ã— 3 = 81' },
                        { question: 'What is the derivative of xÂ²?', answer: '2X', explanation: 'Using the power rule: derivative of xÂ² is 2x' },
                        { question: 'What is logâ‚â‚€(100)?', answer: '2', explanation: '10Â² = 100, so logâ‚â‚€(100) = 2' },
                        { question: 'What is sin(90Â°)?', answer: '1', explanation: 'sin(90Â°) = 1' }
                    ]
                };
                
                const puzzle = puzzles[difficulty][Math.floor(Math.random() * puzzles[difficulty].length)];
                return {
                    question: puzzle.question,
                    answer: puzzle.answer,
                    explanation: puzzle.explanation,
                    type: 'Math Puzzle',
                    difficulty: difficulty,
                    hints: [
                        'Break down the problem step by step',
                        'Use basic arithmetic operations',
                        'Check your calculations',
                        'For algebra, isolate the variable',
                        'Remember mathematical formulas'
                    ]
                };
            }
        },
        {
            name: 'Riddle',
            description: 'Solve the riddle',
            icon: 'fas fa-question-circle',
            generate: function(difficulty) {
                const riddles = {
                    easy: [
                        { question: 'What has a head, a tail, but no body?', answer: 'COIN', explanation: 'A coin has a head and tail but no body' },
                        { question: 'What gets wetter as it dries?', answer: 'TOWEL', explanation: 'A towel dries things but gets wet in the process' },
                        { question: 'What has hands but can\'t clap?', answer: 'CLOCK', explanation: 'Clock has hands (hour and minute) but can\'t clap' },
                        { question: 'What has an eye but cannot see?', answer: 'NEEDLE', explanation: 'A needle has an eye but cannot see' },
                        { question: 'What has a neck but no head?', answer: 'BOTTLE', explanation: 'A bottle has a neck but no head' },
                        { question: 'What has a thumb and four fingers but is not alive?', answer: 'GLOVE', explanation: 'A glove has finger spaces but is not alive' },
                        { question: 'What has a ring but no finger?', answer: 'TELEPHONE', explanation: 'A telephone rings but has no finger' },
                        { question: 'What has keys that open no locks?', answer: 'PIANO', explanation: 'A piano has keys but no locks' },
                        { question: 'What has teeth but can\'t bite?', answer: 'COMB', explanation: 'A comb has teeth but can\'t bite' },
                        { question: 'What has a face but no eyes, hands but no arms?', answer: 'CLOCK', explanation: 'A clock has a face and hands but no eyes or arms' }
                    ],
                    medium: [
                        { question: 'What has cities but no houses, forests but no trees, and water but no fish?', answer: 'MAP', explanation: 'A map shows these features but doesn\'t contain them' },
                        { question: 'What belongs to you but is used more by others?', answer: 'NAME', explanation: 'Your name is yours but others use it more often' },
                        { question: 'What can you catch but not throw?', answer: 'COLD', explanation: 'You catch a cold, but you don\'t throw it' },
                        { question: 'What has words but never speaks?', answer: 'BOOK', explanation: 'A book has words but cannot speak' },
                        { question: 'I\'m tall when I\'m young and short when I\'m old. What am I?', answer: 'CANDLE', explanation: 'A candle is tall when new and short when burned' },
                        { question: 'What can travel around the world while staying in a corner?', answer: 'STAMP', explanation: 'A postage stamp stays in the corner of an envelope as it travels' },
                        { question: 'What has a bed but never sleeps, a mouth but never eats?', answer: 'RIVER', explanation: 'A river has a riverbed and a mouth but doesn\'t sleep or eat' },
                        { question: 'What has a heart that doesn\'t beat?', answer: 'ARTICHOKE', explanation: 'An artichoke has a heart but it doesn\'t beat' },
                        { question: 'What can be broken without being touched?', answer: 'PROMISE', explanation: 'A promise can be broken without physical touch' },
                        { question: 'What has a head and a tail but no body?', answer: 'COIN', explanation: 'A coin has a head and tail but no body' }
                    ],
                    hard: [
                        { question: 'If you have me, you want to share me. If you share me, you no longer have me. What am I?', answer: 'SECRET', explanation: 'Secrets lose their nature when shared' },
                        { question: 'I am not alive, but I grow; I don\'t have lungs, but I need air; I don\'t have a mouth, but water kills me. What am I?', answer: 'FIRE', explanation: 'Fire grows, needs oxygen, and is extinguished by water' },
                        { question: 'The person who makes it, sells it. The person who buys it never uses it. The person who uses it never knows they\'re using it. What is it?', answer: 'COFFIN', explanation: 'A coffin maker sells it, the buyer doesn\'t use it, and the user (dead) doesn\'t know' },
                        { question: 'What can run but never walks, has a mouth but never talks, has a head but never weeps, has a bed but never sleeps?', answer: 'RIVER', explanation: 'A river runs, has a mouth, headwaters, and a riverbed' },
                        { question: 'What goes through cities and fields but never moves?', answer: 'ROAD', explanation: 'A road goes through places but is stationary' },
                        { question: 'I am always hungry, I must always be fed. The finger I touch will soon turn red. What am I?', answer: 'FIRE', explanation: 'Fire consumes fuel, and touching fire burns' },
                        { question: 'What has keys that open no locks, space but no room, and you can enter but not go in?', answer: 'KEYBOARD', explanation: 'A keyboard has keys, space bar, and enter key but no physical spaces' },
                        { question: 'I have branches but no fruit, trunk, or leaves. What am I?', answer: 'BANK', explanation: 'A bank has branches but is not a tree' },
                        { question: 'The more of me you take, the more you leave behind. What am I?', answer: 'FOOTSTEPS', explanation: 'Footsteps are left behind as you walk' },
                        { question: 'I am always in front of you but cannot be seen. What am I?', answer: 'FUTURE', explanation: 'The future is always ahead but cannot be seen' }
                    ]
                };
                
                const riddle = riddles[difficulty][Math.floor(Math.random() * riddles[difficulty].length)];
                return {
                    question: riddle.question,
                    answer: riddle.answer.toUpperCase(),
                    explanation: riddle.explanation,
                    type: 'Riddle',
                    difficulty: difficulty,
                    hints: [
                        'Think metaphorically',
                        'Consider multiple meanings of words',
                        'Sometimes the answer is a play on words',
                        'Look for double meanings',
                        'Don\'t take the question literally'
                    ]
                };
            }
        },
        {
            name: 'Visual Pattern',
            description: 'Identify the visual pattern',
            icon: 'fas fa-eye',
            generate: function(difficulty) {
                const patterns = {
                    easy: [
                        { pattern: 'â–³, â–¡, â–³, â–¡, ?', answer: 'â–³', explanation: 'Alternating triangle and square' },
                        { pattern: 'ðŸ”´, ðŸ”µ, ðŸ”´, ðŸ”µ, ?', answer: 'ðŸ”´', explanation: 'Alternating red and blue circles' },
                        { pattern: '1, 3, 5, 7, ?', answer: '9', explanation: 'Odd numbers increasing by 2' },
                        { pattern: 'A, B, C, D, ?', answer: 'E', explanation: 'Alphabetical order' },
                        { pattern: 'â–², â–²â–², â–²â–²â–², â–²â–²â–²â–², ?', answer: 'â–²â–²â–²â–²â–²', explanation: 'Increasing number of triangles by 1 each time' },
                        { pattern: 'â—, â—â—, â—â—â—, â—â—â—â—, ?', answer: 'â—â—â—â—â—', explanation: 'Increasing number of circles by 1 each time' },
                        { pattern: '2, 4, 6, 8, ?', answer: '10', explanation: 'Even numbers increasing by 2' },
                        { pattern: 'â¤ï¸, ðŸ’›, ðŸ’š, ðŸ’™, ?', answer: 'ðŸ’œ', explanation: 'Rainbow colors in order' },
                        { pattern: 'â†‘, â†’, â†“, ?', answer: 'â†', explanation: 'Rotating arrows clockwise' },
                        { pattern: 'ðŸŒž, ðŸŒ›, ðŸŒž, ðŸŒ›, ?', answer: 'ðŸŒž', explanation: 'Alternating sun and moon' }
                    ],
                    medium: [
                        { pattern: 'â–², â–¼, â—€, â–¶, ?', answer: 'â–²', explanation: 'Rotating through triangle directions' },
                        { pattern: 'A, C, E, G, ?', answer: 'I', explanation: 'Every other letter (skip one letter)' },
                        { pattern: 'â™ , â™¥, â™¦, â™£, ?', answer: 'â™ ', explanation: 'Card suits in standard order' },
                        { pattern: '1, 2, 4, 8, 16, ?', answer: '32', explanation: 'Doubling each time' },
                        { pattern: 'â¬›, â¬œ, â¬›, â¬œ, ?', answer: 'â¬›', explanation: 'Alternating black and white squares' },
                        { pattern: '1, 4, 9, 16, 25, ?', answer: '36', explanation: 'Square numbers (1Â², 2Â², 3Â², 4Â², 5Â², 6Â²)' },
                        { pattern: 'ðŸ¶, ðŸ±, ðŸ­, ðŸ¹, ?', answer: 'ðŸ°', explanation: 'Common pets' },
                        { pattern: 'ðŸŽ, ðŸ, ðŸŠ, ðŸ‹, ?', answer: 'ðŸŒ', explanation: 'Fruits' },
                        { pattern: 'â… , â…¡, â…¢, â…£, ?', answer: 'â…¤', explanation: 'Roman numerals 1-5' },
                        { pattern: 'ðŸŒ±, ðŸŒ¿, ðŸ€, ðŸƒ, ?', answer: 'ðŸŒ¾', explanation: 'Plants/leaves' }
                    ],
                    hard: [
                        { pattern: '1, 4, 9, 16, 25, ?', answer: '36', explanation: 'Square numbers (1Â², 2Â², 3Â², 4Â², 5Â², 6Â²)' },
                        { pattern: 'â¬¤, â¬¤â¬¤, â¬¤â¬¤â¬¤, â¬¤â¬¤â¬¤â¬¤, ?', answer: 'â¬¤â¬¤â¬¤â¬¤â¬¤', explanation: 'Increasing number of circles by 1 each time' },
                        { pattern: 'M, V, E, M, J, ?', answer: 'S', explanation: 'First letters of planets in order from the Sun: Mercury, Venus, Earth, Mars, Jupiter, Saturn' },
                        { pattern: '1, 11, 21, 1211, 111221, ?', answer: '312211', explanation: 'Look-and-say sequence: describe the previous term' },
                        { pattern: 'ðŸŒ•, ðŸŒ–, ðŸŒ—, ðŸŒ˜, ?', answer: 'ðŸŒ‘', explanation: 'Moon phases' },
                        { pattern: 'â™ˆ, â™‰, â™Š, â™‹, ?', answer: 'â™Œ', explanation: 'Zodiac signs in order' },
                        { pattern: 'â… , â… â… , â… â… â… , â… â…¤, ?', answer: 'â…¤', explanation: 'Roman numerals 1-5' },
                        { pattern: 'ðŸ”¥, ðŸ’§, ðŸŒªï¸, ðŸŒ, ?', answer: 'âš¡', explanation: 'Classical elements (fire, water, air, earth) + lightning' },
                        { pattern: 'ðŸŽµ, ðŸŽ¶, ðŸŽµ, ðŸŽ¶, ?', answer: 'ðŸŽµ', explanation: 'Alternating musical notes' },
                        { pattern: 'ðŸ•, ðŸ•‘, ðŸ•’, ðŸ•“, ?', answer: 'ðŸ•”', explanation: 'Clock times increasing by one hour' }
                    ]
                };
                
                const pattern = patterns[difficulty][Math.floor(Math.random() * patterns[difficulty].length)];
                return {
                    question: `Complete the pattern: <span class="visual-pattern">${pattern.pattern}</span>`,
                    answer: pattern.answer,
                    explanation: pattern.explanation,
                    type: 'Visual Pattern',
                    difficulty: difficulty,
                    hints: [
                        'Look for repeating sequences',
                        'Count the number of elements',
                        'Consider rotation or transformation',
                        'Think about mathematical sequences',
                        'Visualize the pattern in your mind'
                    ]
                };
            }
        },
        {
            name: 'Memory Challenge',
            description: 'Remember and recall information',
            icon: 'fas fa-brain',
            generate: function(difficulty) {
                const memoryTests = {
                    easy: [
                        { 
                            question: 'Remember these three items: Apple, Book, Cat. What was the second item?', 
                            answer: 'BOOK', 
                            explanation: 'The items were: 1. Apple, 2. Book, 3. Cat' 
                        },
                        { 
                            question: 'Remember this sequence: 5, 9, 2. What was the first number?', 
                            answer: '5', 
                            explanation: 'The sequence was: 5, 9, 2' 
                        },
                        { 
                            question: 'Remember these colors: Red, Blue, Green. Which color was in the middle?', 
                            answer: 'BLUE', 
                            explanation: 'The colors were: Red, Blue, Green' 
                        },
                        { 
                            question: 'Remember these shapes: Circle, Square, Triangle. What was the last shape?', 
                            answer: 'TRIANGLE', 
                            explanation: 'The shapes were: Circle, Square, Triangle' 
                        },
                        { 
                            question: 'Remember these words: Sun, Moon, Star. What was the first word?', 
                            answer: 'SUN', 
                            explanation: 'The words were: Sun, Moon, Star' 
                        }
                    ],
                    medium: [
                        { 
                            question: 'Remember this sequence: 7, 3, 9, 1. What is the sum of the first and last numbers?', 
                            answer: '8', 
                            explanation: 'The sequence was: 7, 3, 9, 1. 7 (first) + 1 (last) = 8' 
                        },
                        { 
                            question: 'Remember these animals: Lion, Tiger, Bear, Elephant. Which animal was third?', 
                            answer: 'BEAR', 
                            explanation: 'The animals were: Lion, Tiger, Bear, Elephant' 
                        },
                        { 
                            question: 'Remember these items: Pen, Paper, Scissors, Rock. What comes after Paper?', 
                            answer: 'SCISSORS', 
                            explanation: 'The items were: Pen, Paper, Scissors, Rock' 
                        },
                        { 
                            question: 'Remember this pattern: X, O, X, O. What comes next?', 
                            answer: 'X', 
                            explanation: 'The pattern alternates: X, O, X, O, X' 
                        },
                        { 
                            question: 'Remember these numbers: 12, 24, 36, 48. What is the pattern?', 
                            answer: 'MULTIPLY BY 2', 
                            explanation: 'Each number is double the previous (actually adding 12, but common answer is multiply by 2)' 
                        }
                    ],
                    hard: [
                        { 
                            question: 'Remember this sequence: 2, 5, 11, 23. What is the next number? (Hint: Multiply by 2 and add 1)', 
                            answer: '47', 
                            explanation: 'The pattern: 2Ã—2+1=5, 5Ã—2+1=11, 11Ã—2+1=23, 23Ã—2+1=47' 
                        },
                        { 
                            question: 'Remember these words: Logic, Puzzle, Brain, Teaser, Challenge. How many words started with consonants?', 
                            answer: '5', 
                            explanation: 'All words start with consonants: Logic (L), Puzzle (P), Brain (B), Teaser (T), Challenge (C)' 
                        },
                        { 
                            question: 'Remember this sequence: A, D, G, J. What letter comes next?', 
                            answer: 'M', 
                            explanation: 'The pattern: A (+3) = D, D (+3) = G, G (+3) = J, J (+3) = M' 
                        },
                        { 
                            question: 'Remember these numbers: 3, 9, 27, 81. What is the rule?', 
                            answer: 'MULTIPLY BY 3', 
                            explanation: 'Each number is multiplied by 3 to get the next: 3Ã—3=9, 9Ã—3=27, 27Ã—3=81' 
                        },
                        { 
                            question: 'Remember these symbols: â™ , â™¥, â™¦, â™£, â˜…. Which symbol was in position 4?', 
                            answer: 'â™£', 
                            explanation: 'The symbols were: 1. â™ , 2. â™¥, 3. â™¦, 4. â™£, 5. â˜…' 
                        }
                    ]
                };
                
                const test = memoryTests[difficulty][Math.floor(Math.random() * memoryTests[difficulty].length)];
                return {
                    question: test.question,
                    answer: test.answer,
                    explanation: test.explanation,
                    type: 'Memory Challenge',
                    difficulty: difficulty,
                    hints: [
                        'Try to visualize the information',
                        'Create a story or association',
                        'Repeat the information to yourself',
                        'Break it into smaller chunks',
                        'Focus on patterns or relationships'
                    ]
                };
            }
        }
    ],
    
    // Initialize the app
    init: function() {
        console.log('Initializing NeuroPuzzle...');
        
        try {
            // Check if user is logged in
            this.checkUserLogin();
            
            // Initialize UI
            this.initUI();
            
            // Initialize mode selection
            this.initModeSelection();
            
            // Initialize difficulty selection
            this.initDifficultySelection();
            
            // Initialize event listeners
            this.initEventListeners();
            
            // Initialize timer display
            this.updateTimerDisplay();
            
            // Apply saved theme preferences
            this.applyTheme();
            
            console.log('NeuroPuzzle initialized successfully!');
            
            // Show welcome message
            setTimeout(() => {
                this.showNotification(`Welcome to NeuroPuzzle, ${this.currentUser}! Select a mode and difficulty to start.`, 'success');
            }, 500);
            
        } catch (error) {
            console.error('Error during initialization:', error);
            console.log('App initialized with minor errors. Game should still work.');
        }
    },
    
    // Check if user is logged in
    checkUserLogin: function() {
        const currentUser = localStorage.getItem('currentUser');
        if (!currentUser) {
            // Create a test user for demo
            this.currentUser = 'BrainMaster';
            this.userData = {
                neuropuzzle: {
                    iqScore: 100,
                    streak: 0,
                    level: 1,
                    totalSolved: 0,
                    solvedToday: 0,
                    lastPlayed: new Date().toDateString(),
                    accuracy: 0,
                    modes: {},
                    history: [],
                    preferences: {
                        difficulty: 'medium',
                        sound: true,
                        animations: true,
                        darkMode: true
                    }
                }
            };
            
            // Initialize each mode
            this.gameModes.forEach(mode => {
                this.userData.neuropuzzle.modes[mode.id] = {
                    puzzlesSolved: 0,
                    bestLevel: 1,
                    avgTime: 0,
                    accuracy: 0,
                    lastPlayed: null,
                    bestScore: 0,
                    bestStreak: 0
                };
            });
            
            this.saveUserData();
        } else {
            this.currentUser = currentUser;
            this.loadUserData();
        }
        
        // Set difficulty from user preferences
        this.currentDifficulty = this.userData.neuropuzzle.preferences?.difficulty || 'medium';
        
        // Update UI with user info
        this.updateUserDisplay();
    },
    
    // Load user data from localStorage
    loadUserData: function() {
        const users = JSON.parse(localStorage.getItem('users')) || {};
        if (users[this.currentUser]) {
            this.userData = users[this.currentUser];
            
            // Initialize neuropuzzle data if not exists
            if (!this.userData.neuropuzzle) {
                this.userData.neuropuzzle = {
                    iqScore: 100,
                    streak: 0,
                    level: 1,
                    totalSolved: 0,
                    solvedToday: 0,
                    lastPlayed: new Date().toDateString(),
                    accuracy: 0,
                    modes: {},
                    history: [],
                    preferences: {
                        difficulty: 'medium',
                        sound: true,
                        animations: true,
                        darkMode: true
                    }
                };
                
                // Initialize each mode
                this.gameModes.forEach(mode => {
                    this.userData.neuropuzzle.modes[mode.id] = {
                        puzzlesSolved: 0,
                        bestLevel: 1,
                        avgTime: 0,
                        accuracy: 0,
                        lastPlayed: null,
                        bestScore: 0,
                        bestStreak: 0
                    };
                });
                
                this.saveUserData();
            }
            
            // Check if it's a new day for streak calculation
            this.checkNewDay();
            
        } else {
            // User doesn't exist in users data, create new
            this.userData = {
                neuropuzzle: {
                    iqScore: 100,
                    streak: 0,
                    level: 1,
                    totalSolved: 0,
                    solvedToday: 0,
                    lastPlayed: new Date().toDateString(),
                    accuracy: 0,
                    modes: {},
                    history: [],
                    preferences: {
                        difficulty: 'medium',
                        sound: true,
                        animations: true,
                        darkMode: true
                    }
                }
            };
            
            // Initialize each mode
            this.gameModes.forEach(mode => {
                this.userData.neuropuzzle.modes[mode.id] = {
                    puzzlesSolved: 0,
                    bestLevel: 1,
                    avgTime: 0,
                    accuracy: 0,
                    lastPlayed: null,
                    bestScore: 0,
                    bestStreak: 0
                };
            });
            
            this.saveUserData();
        }
    },
    
    // Check if it's a new day for streak
    checkNewDay: function() {
        const today = new Date().toDateString();
        const lastPlayed = this.userData.neuropuzzle.lastPlayed;
        
        if (lastPlayed !== today) {
            // Check if streak should be maintained (played yesterday)
            const lastPlayedDate = new Date(lastPlayed);
            const todayDate = new Date();
            const timeDiff = todayDate - lastPlayedDate;
            const daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
            
            if (daysDiff > 1) {
                // More than one day break, reset streak
                this.userData.neuropuzzle.streak = 0;
                this.userData.neuropuzzle.solvedToday = 0;
            } else if (daysDiff === 1) {
                // Consecutive day, maintain streak
                this.userData.neuropuzzle.solvedToday = 0;
            }
        }
    },
    
    // Save user data to localStorage
    saveUserData: function() {
        if (!this.currentUser || !this.userData) return;
        
        const users = JSON.parse(localStorage.getItem('users')) || {};
        users[this.currentUser] = this.userData;
        localStorage.setItem('users', JSON.stringify(users));
    },
    
    // Update user display
    updateUserDisplay: function() {
        if (!this.currentUser || !this.userData) return;
        
        const firstLetter = this.currentUser.charAt(0).toUpperCase();
        const np = this.userData.neuropuzzle;
        
        // Update mode panel
        const modeUserAvatar = document.getElementById('mode-user-avatar');
        const modeUserName = document.getElementById('mode-user-name');
        const modeIqScore = document.getElementById('mode-iq-score');
        
        if (modeUserAvatar) modeUserAvatar.textContent = firstLetter;
        if (modeUserName) modeUserName.textContent = this.currentUser;
        if (modeIqScore) modeIqScore.textContent = np.iqScore;
        
        // Update game header
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        
        if (userAvatar) userAvatar.textContent = firstLetter;
        if (userName) userName.textContent = this.currentUser;
        
        // Update progress summary
        this.updateProgressSummary();
    },
    
    // Update progress summary in mode panel
    updateProgressSummary: function() {
        if (!this.userData.neuropuzzle) return;
        
        const np = this.userData.neuropuzzle;
        
        const totalSolvedEl = document.getElementById('total-solved');
        const currentStreakEl = document.getElementById('current-streak');
        const accuracyRateEl = document.getElementById('accuracy-rate');
        const bestLevelEl = document.getElementById('best-level');
        
        if (totalSolvedEl) totalSolvedEl.textContent = np.totalSolved;
        if (currentStreakEl) currentStreakEl.textContent = np.streak;
        if (accuracyRateEl) accuracyRateEl.textContent = np.accuracy.toFixed(1) + '%';
        if (bestLevelEl) bestLevelEl.textContent = np.level;
    },
    
    // Initialize UI
    initUI: function() {
        // Update all UI elements with user data
        this.updateGameUI();
        
        // Ensure mode panel is visible initially
        const modePanel = document.getElementById('mode-panel');
        const appContainer = document.getElementById('app-container');
        const pauseOverlay = document.getElementById('pause-overlay');
        const historyPanelOverlay = document.getElementById('history-panel-overlay');
        const settingsModal = document.getElementById('settings-modal');
        
        if (modePanel) modePanel.style.display = 'flex';
        if (appContainer) appContainer.style.display = 'none';
        if (pauseOverlay) pauseOverlay.style.display = 'none';
        if (historyPanelOverlay) historyPanelOverlay.style.display = 'none';
        if (settingsModal) settingsModal.style.display = 'none';
        
        // Update difficulty display
        this.updateDifficultyDisplay();
        
        // Add floating particles for visual effect
        this.createFloatingParticles();
        
        // Initialize quick mode switcher
        this.initQuickModeSwitcher();
    },
    
    // Create floating particles for visual effect
    createFloatingParticles: function() {
        const particleContainer = document.getElementById('particle-container');
        if (!particleContainer) return;
        
        // Clear any existing particles
        particleContainer.innerHTML = '';
        
        // Create particles
        const particleCount = 30;
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            
            // Random properties
            const size = Math.random() * 10 + 5;
            const posX = Math.random() * 100;
            const posY = Math.random() * 100;
            const duration = Math.random() * 20 + 10;
            const delay = Math.random() * 5;
            
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            particle.style.left = `${posX}%`;
            particle.style.top = `${posY}%`;
            particle.style.animationDuration = `${duration}s`;
            particle.style.animationDelay = `${delay}s`;
            
            // Random shape
            const shapes = ['circle', 'square', 'triangle'];
            const shape = shapes[Math.floor(Math.random() * shapes.length)];
            
            if (shape === 'circle') {
                particle.style.borderRadius = '50%';
            } else if (shape === 'triangle') {
                particle.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
            }
            
            // Random color
            const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            particle.style.backgroundColor = color;
            particle.style.opacity = Math.random() * 0.3 + 0.1;
            
            particleContainer.appendChild(particle);
        }
    },
    
    // Initialize quick mode switcher
    initQuickModeSwitcher: function() {
        const quickModeContainer = document.getElementById('quick-mode-switcher');
        if (!quickModeContainer) return;
        
        quickModeContainer.innerHTML = '';
        
        // Add only 4 popular modes for quick switching
        const quickModes = this.gameModes.filter(mode => 
            ['adaptive', 'timed', 'survival', 'mixed'].includes(mode.id)
        );
        
        quickModes.forEach(mode => {
            const modeBtn = document.createElement('button');
            modeBtn.className = `quick-mode-btn ${this.currentMode === mode.id ? 'active' : ''}`;
            modeBtn.dataset.modeId = mode.id;
            modeBtn.title = mode.name;
            modeBtn.innerHTML = `<i class="${mode.icon}"></i>`;
            
            modeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (this.gameActive) {
                    this.showNotification('Pause the game first to change mode!', 'warning');
                    this.pauseGame();
                    return;
                }
                this.selectMode(mode.id);
                this.updateQuickModeSwitcher();
            });
            
            quickModeContainer.appendChild(modeBtn);
        });
    },
    
    // Update quick mode switcher
    updateQuickModeSwitcher: function() {
        document.querySelectorAll('.quick-mode-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.modeId === this.currentMode) {
                btn.classList.add('active');
            }
        });
    },
    
    // Update game UI with user stats
    updateGameUI: function() {
        if (!this.userData.neuropuzzle) return;
        
        const np = this.userData.neuropuzzle;
        
        const streakCounter = document.getElementById('streak-counter');
        const levelCounter = document.getElementById('level-counter');
        const iqScore = document.getElementById('iq-score');
        const solvedToday = document.getElementById('solved-today');
        const bestStreak = document.getElementById('best-streak');
        const progressFill = document.getElementById('progress-fill');
        const progressPercent = document.getElementById('progress-percent');
        
        if (streakCounter) streakCounter.textContent = np.streak;
        if (levelCounter) levelCounter.textContent = np.level;
        if (iqScore) iqScore.textContent = np.iqScore;
        if (solvedToday) solvedToday.textContent = np.solvedToday;
        if (bestStreak) bestStreak.textContent = Math.max(np.streak, np.bestStreak || 0);
        
        // Calculate and update progress
        const progressPercentValue = Math.min(100, (np.solvedToday / 10) * 100);
        if (progressFill) progressFill.style.width = progressPercentValue + '%';
        if (progressPercent) progressPercent.textContent = Math.round(progressPercentValue) + '%';
    },
    
    // Initialize mode selection UI
    initModeSelection: function() {
        const modeGrid = document.getElementById('mode-grid');
        if (!modeGrid) return;
        
        modeGrid.innerHTML = '';
        
        this.gameModes.forEach(mode => {
            const modeData = this.userData.neuropuzzle.modes[mode.id] || { 
                puzzlesSolved: 0, 
                bestLevel: 1,
                bestScore: 0,
                bestStreak: 0
            };
            
            const modeCard = document.createElement('div');
            modeCard.className = 'mode-card';
            modeCard.dataset.modeId = mode.id;
            modeCard.style.background = mode.bgColor;
            
            modeCard.innerHTML = `
                <div class="mode-card-inner">
                    <div class="mode-icon">
                        <i class="${mode.icon}"></i>
                    </div>
                    <div class="mode-content">
                        <div class="mode-title">${mode.name}</div>
                        <div class="mode-desc">${mode.description}</div>
                        <div class="mode-features">
                            ${mode.features.map(feature => `<span class="mode-feature">${feature}</span>`).join('')}
                        </div>
                        <div class="mode-stats">
                            <div class="mode-stat">
                                <span class="stat-label">Solved:</span>
                                <span class="stat-value">${modeData.puzzlesSolved}</span>
                            </div>
                            <div class="mode-stat">
                                <span class="stat-label">Best:</span>
                                <span class="stat-value">${mode.id === 'timed' ? `Score: ${modeData.bestScore}` : mode.id === 'survival' ? `Streak: ${modeData.bestStreak}` : `Level ${modeData.bestLevel}`}</span>
                            </div>
                        </div>
                    </div>
                    ${mode.unlocked ? '' : '<div class="mode-tag">Locked</div>'}
                    ${this.currentMode === mode.id ? '<div class="mode-tag active">Active</div>' : ''}
                </div>
            `;
            
            modeCard.addEventListener('click', () => {
                if (this.gameActive && !this.gamePaused) {
                    this.showNotification('Pause the game first before changing mode!', 'warning');
                    return;
                }
                this.selectMode(mode.id);
            });
            modeGrid.appendChild(modeCard);
        });
        
        // Set default mode if none selected
        if (!this.currentMode) {
            this.selectMode('adaptive');
        } else {
            // Highlight the current mode
            const selectedCard = document.querySelector(`[data-mode-id="${this.currentMode}"]`);
            if (selectedCard) {
                selectedCard.classList.add('active');
            }
        }
    },
    
    // Initialize difficulty selection
    initDifficultySelection: function() {
        const difficultyContainer = document.getElementById('difficulty-selector');
        if (!difficultyContainer) return;
        
        difficultyContainer.innerHTML = '';
        
        this.difficulties.forEach(diff => {
            const diffBtn = document.createElement('button');
            diffBtn.className = `difficulty-btn ${this.currentDifficulty === diff.id ? 'active' : ''}`;
            diffBtn.dataset.difficulty = diff.id;
            diffBtn.style.background = diff.gradient;
            diffBtn.innerHTML = `
                <i class="${diff.icon}"></i>
                <span class="difficulty-name">${diff.name}</span>
                <span class="difficulty-desc">${diff.description}</span>
                <span class="difficulty-multiplier">${diff.multiplier}x points</span>
            `;
            
            diffBtn.addEventListener('click', () => {
                if (this.gameActive && !this.gamePaused) {
                    this.showNotification('Pause the game first before changing difficulty!', 'warning');
                    return;
                }
                this.selectDifficulty(diff.id);
            });
            difficultyContainer.appendChild(diffBtn);
        });
        
        // Update difficulty display in game
        this.updateDifficultyDisplay();
    },
    
    // Select a game mode
    selectMode: function(modeId) {
        this.currentMode = modeId;
        
        // Remove active class from all cards
        document.querySelectorAll('.mode-card').forEach(card => {
            card.classList.remove('active');
        });
        
        // Add active class to selected card
        const selectedCard = document.querySelector(`[data-mode-id="${modeId}"]`);
        if (selectedCard) {
            selectedCard.classList.add('active');
        }
        
        // Update mode display in game
        const mode = this.gameModes.find(m => m.id === modeId);
        if (mode) {
            const currentModeName = document.getElementById('current-mode-name');
            const currentModeIcon = document.getElementById('current-mode-icon');
            const currentModeDisplay = document.getElementById('current-mode-display');
            const modeDescription = document.getElementById('mode-description');
            
            if (currentModeName) currentModeName.textContent = mode.name;
            if (currentModeIcon) currentModeIcon.className = mode.icon;
            if (currentModeDisplay) currentModeDisplay.textContent = mode.name;
            if (modeDescription) modeDescription.textContent = mode.description;
            
            // Update quick mode switcher
            this.updateQuickModeSwitcher();
        }
        
        this.showNotification(`Mode set to: ${mode.name}`, 'info');
    },
    
    // Select difficulty
    selectDifficulty: function(difficultyId) {
        this.currentDifficulty = difficultyId;
        
        // Update user preferences
        if (this.userData.neuropuzzle.preferences) {
            this.userData.neuropuzzle.preferences.difficulty = difficultyId;
            this.saveUserData();
        }
        
        // Update UI
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.difficulty === difficultyId) {
                btn.classList.add('active');
            }
        });
        
        this.updateDifficultyDisplay();
        
        // Show notification
        const difficulty = this.difficulties.find(d => d.id === difficultyId);
        this.showNotification(`Difficulty set to ${difficulty.name}`, 'info');
        
        // Regenerate puzzle if in game
        if (this.gameActive && this.currentPuzzle) {
            this.generatePuzzle();
        }
    },
    
    // Update difficulty display in game
    updateDifficultyDisplay: function() {
        const difficultyDisplay = document.getElementById('current-difficulty-display');
        const difficultyBadge = document.getElementById('difficulty-badge');
        const difficulty = this.difficulties.find(d => d.id === this.currentDifficulty);
        
        if (difficulty) {
            if (difficultyDisplay) {
                difficultyDisplay.textContent = difficulty.name;
                difficultyDisplay.style.background = difficulty.gradient;
                difficultyDisplay.style.fontWeight = 'bold';
            }
            
            if (difficultyBadge) {
                difficultyBadge.textContent = difficulty.name;
                difficultyBadge.style.background = difficulty.gradient;
            }
        }
    },
    
    // Initialize event listeners
    initEventListeners: function() {
        // Start game button
        const startBtn = document.getElementById('start-game-btn');
        if (startBtn) {
            startBtn.addEventListener('click', () => {
                if (!this.currentMode) {
                    this.selectMode('adaptive');
                }
                
                // Hide mode panel, show game
                const modePanel = document.getElementById('mode-panel');
                const appContainer = document.getElementById('app-container');
                
                if (modePanel) modePanel.style.display = 'none';
                if (appContainer) {
                    appContainer.style.display = 'block';
                    // Add animation
                    this.addAnimation(appContainer, 'slideInRight');
                }
                
                // Start the game
                this.startGame();
            });
        }
        
        // Change mode buttons
        const changeModeBtn = document.getElementById('change-mode-btn');
        if (changeModeBtn) {
            changeModeBtn.addEventListener('click', () => {
                this.showModeSelection();
            });
        }
        
        const pauseChangeMode = document.getElementById('pause-change-mode');
        if (pauseChangeMode) {
            pauseChangeMode.addEventListener('click', () => {
                const pauseOverlay = document.getElementById('pause-overlay');
                if (pauseOverlay) pauseOverlay.style.display = 'none';
                this.showModeSelection();
            });
        }
        
        const changeModeSettings = document.getElementById('change-mode-settings');
        if (changeModeSettings) {
            changeModeSettings.addEventListener('click', () => {
                const settingsModal = document.getElementById('settings-modal');
                if (settingsModal) settingsModal.style.display = 'none';
                this.showModeSelection();
            });
        }
        
        // Logout buttons
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => this.logout());
        }
        
        const headerLogoutBtn = document.getElementById('header-logout-btn');
        if (headerLogoutBtn) {
            headerLogoutBtn.addEventListener('click', () => this.logout());
        }
        
        // Game controls
        const gamePauseBtn = document.getElementById('game-pause-btn');
        if (gamePauseBtn) {
            gamePauseBtn.addEventListener('click', () => {
                this.pauseGame();
            });
        }
        
        const resumeBtn = document.getElementById('resume-btn');
        if (resumeBtn) {
            resumeBtn.addEventListener('click', () => {
                this.resumeGame();
            });
        }
        
        const submitBtn = document.getElementById('submit-btn');
        if (submitBtn) {
            submitBtn.addEventListener('click', () => {
                this.submitAnswer();
            });
        }
        
        const answerInput = document.getElementById('answer-input');
        if (answerInput) {
            answerInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.submitAnswer();
                }
            });
        }
        
        const hintBtn = document.getElementById('hint-btn');
        if (hintBtn) {
            hintBtn.addEventListener('click', () => {
                this.showHint();
            });
        }
        
        // Settings
        const settingsBtn = document.getElementById('settings-btn');
        if (settingsBtn) {
            settingsBtn.addEventListener('click', () => {
                const settingsModal = document.getElementById('settings-modal');
                if (settingsModal) {
                    settingsModal.style.display = 'flex';
                    this.addAnimation(settingsModal, 'fadeIn');
                }
                this.loadSettings();
            });
        }
        
        const modalClose = document.getElementById('modal-close');
        if (modalClose) {
            modalClose.addEventListener('click', () => {
                const settingsModal = document.getElementById('settings-modal');
                if (settingsModal) settingsModal.style.display = 'none';
            });
        }
        
        // History
        const historyTabBtn = document.getElementById('history-tab-btn');
        if (historyTabBtn) {
            historyTabBtn.addEventListener('click', () => {
                const historyPanel = document.getElementById('history-panel-overlay');
                if (historyPanel) {
                    historyPanel.style.display = 'block';
                    this.addAnimation(historyPanel, 'slideInLeft');
                }
                this.loadHistory();
            });
        }
        
        const historyClose = document.getElementById('history-close');
        if (historyClose) {
            historyClose.addEventListener('click', () => {
                const historyPanel = document.getElementById('history-panel-overlay');
                if (historyPanel) historyPanel.style.display = 'none';
            });
        }
        
        // History tabs
        document.querySelectorAll('.history-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const tabName = e.target.dataset.tab;
                this.switchHistoryTab(tabName);
            });
        });
        
        // Reset progress button
        const resetProgressBtn = document.getElementById('reset-progress-btn');
        if (resetProgressBtn) {
            resetProgressBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                    this.resetProgress();
                }
            });
        }
        
        // Home button
        const homeBtn = document.getElementById('home-btn');
        if (homeBtn) {
            homeBtn.addEventListener('click', () => {
                if (this.gameActive && !this.gamePaused) {
                    this.showNotification('Pause the game first before going to homepage!', 'warning');
                    this.pauseGame();
                    return;
                }
                this.showModeSelection();
            });
        }
        
        const pauseHomeBtn = document.getElementById('pause-home-btn');
        if (pauseHomeBtn) {
            pauseHomeBtn.addEventListener('click', () => {
                const pauseOverlay = document.getElementById('pause-overlay');
                if (pauseOverlay) pauseOverlay.style.display = 'none';
                this.showModeSelection();
            });
        }
        
        // Change difficulty button
        const changeDifficultyBtn = document.getElementById('change-difficulty-btn');
        if (changeDifficultyBtn) {
            changeDifficultyBtn.addEventListener('click', () => {
                if (this.gameActive && !this.gamePaused) {
                    this.showNotification('Pause the game first before changing difficulty!', 'warning');
                    this.pauseGame();
                    return;
                }
                this.showDifficultySelector();
            });
        }
        
        const pauseChangeDifficulty = document.getElementById('pause-change-difficulty');
        if (pauseChangeDifficulty) {
            pauseChangeDifficulty.addEventListener('click', () => {
                const pauseOverlay = document.getElementById('pause-overlay');
                if (pauseOverlay) pauseOverlay.style.display = 'none';
                this.showDifficultySelector();
            });
        }
        
        // Skip puzzle button
        const skipBtn = document.getElementById('skip-btn');
        if (skipBtn) {
            skipBtn.addEventListener('click', () => {
                this.skipPuzzle();
            });
        }
        
        // End session button
        const endSessionBtn = document.getElementById('end-session-btn');
        if (endSessionBtn) {
            endSessionBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to end this session?')) {
                    this.endSession();
                }
            });
        }
        
        // Quick answer buttons
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('quick-btn')) {
                const answerInput = document.getElementById('answer-input');
                if (answerInput) {
                    answerInput.value = e.target.textContent;
                    answerInput.focus();
                    this.addAnimation(e.target, 'pulse');
                }
            }
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            const settingsModal = document.getElementById('settings-modal');
            if (settingsModal && e.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
            
            const pauseOverlay = document.getElementById('pause-overlay');
            if (pauseOverlay && e.target === pauseOverlay) {
                this.resumeGame();
            }
            
            const historyOverlay = document.getElementById('history-panel-overlay');
            if (historyOverlay && e.target === historyOverlay) {
                historyOverlay.style.display = 'none';
            }
            
            const difficultyOverlay = document.getElementById('difficulty-selector-overlay');
            if (difficultyOverlay && e.target === difficultyOverlay) {
                difficultyOverlay.style.display = 'none';
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Escape key to pause/resume
            if (e.key === 'Escape' && this.gameActive) {
                if (this.gamePaused) {
                    this.resumeGame();
                } else {
                    this.pauseGame();
                }
            }
            
            // Ctrl+H for hint
            if (e.ctrlKey && e.key === 'h' && this.gameActive && !this.gamePaused) {
                e.preventDefault();
                this.showHint();
            }
            
            // Ctrl+S to skip
            if (e.ctrlKey && e.key === 's' && this.gameActive && !this.gamePaused) {
                e.preventDefault();
                this.skipPuzzle();
            }
            
            // Ctrl+M to go to mode selection
            if (e.ctrlKey && e.key === 'm') {
                e.preventDefault();
                this.showModeSelection();
            }
        });
        
        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                const headerRight = document.querySelector('.header-right');
                if (headerRight) {
                    headerRight.classList.toggle('mobile-active');
                }
            });
        }
        
        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            const headerRight = document.querySelector('.header-right');
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            
            if (headerRight && headerRight.classList.contains('mobile-active') && 
                !headerRight.contains(e.target) && 
                (!mobileMenuBtn || !mobileMenuBtn.contains(e.target))) {
                headerRight.classList.remove('mobile-active');
            }
        });
    },
    
    // Show mode selection
    showModeSelection: function() {
        this.pauseGame();
        
        const appContainer = document.getElementById('app-container');
        const pauseOverlay = document.getElementById('pause-overlay');
        const settingsModal = document.getElementById('settings-modal');
        const modePanel = document.getElementById('mode-panel');
        const historyPanel = document.getElementById('history-panel-overlay');
        const difficultyOverlay = document.getElementById('difficulty-selector-overlay');
        
        if (appContainer) {
            appContainer.style.display = 'none';
            this.addAnimation(appContainer, 'slideOutRight');
        }
        if (pauseOverlay) pauseOverlay.style.display = 'none';
        if (settingsModal) settingsModal.style.display = 'none';
        if (historyPanel) historyPanel.style.display = 'none';
        if (difficultyOverlay) difficultyOverlay.style.display = 'none';
        
        if (modePanel) {
            modePanel.style.display = 'flex';
            this.addAnimation(modePanel, 'slideInLeft');
        }
        
        // Update mode selection UI
        this.initModeSelection();
    },
    
    // Show difficulty selector
    showDifficultySelector: function() {
        // Create difficulty selector overlay if not exists
        let difficultyOverlay = document.getElementById('difficulty-selector-overlay');
        if (!difficultyOverlay) {
            difficultyOverlay = document.createElement('div');
            difficultyOverlay.id = 'difficulty-selector-overlay';
            difficultyOverlay.className = 'modal-overlay';
            difficultyOverlay.style.display = 'none';
            
            difficultyOverlay.innerHTML = `
                <div class="modal-content difficulty-modal">
                    <div class="modal-header">
                        <h2 class="modal-title"><i class="fas fa-sliders-h"></i> Select Difficulty</h2>
                        <button class="modal-close" id="difficulty-modal-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="difficulty-selector-large" id="difficulty-selector-large">
                            <!-- Difficulty buttons will be added here -->
                        </div>
                        <div class="difficulty-info-box">
                            <h4><i class="fas fa-info-circle"></i> Difficulty Effects</h4>
                            <ul>
                                <li><span class="easy-dot"></span> Easy: 1x points, more time, simpler puzzles</li>
                                <li><span class="medium-dot"></span> Medium: 2x points, balanced challenge</li>
                                <li><span class="hard-dot"></span> Hard: 3x points, less time, complex puzzles</li>
                            </ul>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-primary" id="apply-difficulty-btn">
                                <i class="fas fa-check"></i> Apply Difficulty
                            </button>
                            <button class="btn btn-secondary" id="cancel-difficulty-btn">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(difficultyOverlay);
            
            // Add event listeners for the new elements
            document.getElementById('difficulty-modal-close').addEventListener('click', () => {
                difficultyOverlay.style.display = 'none';
            });
            
            document.getElementById('cancel-difficulty-btn').addEventListener('click', () => {
                difficultyOverlay.style.display = 'none';
            });
            
            document.getElementById('apply-difficulty-btn').addEventListener('click', () => {
                difficultyOverlay.style.display = 'none';
                this.showNotification('Difficulty applied successfully!', 'success');
            });
            
            // Close when clicking outside
            difficultyOverlay.addEventListener('click', (e) => {
                if (e.target === difficultyOverlay) {
                    difficultyOverlay.style.display = 'none';
                }
            });
        }
        
        // Initialize difficulty buttons in the overlay
        const difficultyContainer = document.getElementById('difficulty-selector-large');
        if (difficultyContainer) {
            difficultyContainer.innerHTML = '';
            
            this.difficulties.forEach(diff => {
                const diffBtn = document.createElement('button');
                diffBtn.className = `difficulty-btn-large ${this.currentDifficulty === diff.id ? 'active' : ''}`;
                diffBtn.dataset.difficulty = diff.id;
                diffBtn.style.background = diff.gradient;
                diffBtn.innerHTML = `
                    <div class="difficulty-icon">
                        <i class="${diff.icon}"></i>
                    </div>
                    <div class="difficulty-info">
                        <span class="difficulty-name-large">${diff.name}</span>
                        <span class="difficulty-desc-large">${diff.description}</span>
                        <div class="difficulty-points">
                            <span><i class="fas fa-star"></i> Points: ${diff.multiplier}x</span>
                            <span><i class="fas fa-clock"></i> Time Bonus: ${diff.timeBonus}x</span>
                        </div>
                    </div>
                    ${this.currentDifficulty === diff.id ? '<div class="selected-indicator"><i class="fas fa-check"></i> Selected</div>' : ''}
                `;
                
                diffBtn.addEventListener('click', () => {
                    // Remove active class from all buttons
                    document.querySelectorAll('.difficulty-btn-large').forEach(btn => {
                        btn.classList.remove('active');
                        btn.querySelector('.selected-indicator')?.remove();
                    });
                    // Add active class to clicked button
                    diffBtn.classList.add('active');
                    
                    // Add selected indicator
                    const indicator = document.createElement('div');
                    indicator.className = 'selected-indicator';
                    indicator.innerHTML = '<i class="fas fa-check"></i> Selected';
                    diffBtn.appendChild(indicator);
                    
                    // Update current difficulty
                    this.selectDifficulty(diff.id);
                });
                
                difficultyContainer.appendChild(diffBtn);
            });
        }
        
        // Show the overlay
        difficultyOverlay.style.display = 'flex';
        this.addAnimation(difficultyOverlay, 'fadeIn');
    },
    
    // Start the game
    startGame: function() {
        this.gameActive = true;
        this.gamePaused = false;
        this.sessionTime = 0;
        this.timeLeft = 300; // 5 minutes for timed mode
        this.puzzleHistory = [];
        this.currentPuzzleAttempts = 0;
        this.lives = 3; // Reset lives for survival mode
        this.score = 0;
        this.combo = 0;
        this.hintCount = 3;
        
        // Clear any existing timer
        if (this.timerInterval) {
            clearInterval(this.timerInterval);
        }
        
        // Start timer based on mode
        if (this.currentMode === 'timed') {
            this.startTimedMode();
        } else {
            this.startTimer();
        }
        
        // Generate first puzzle
        this.generatePuzzle();
        
        // Update UI
        const userStatus = document.getElementById('user-status');
        const gamePauseBtn = document.getElementById('game-pause-btn');
        
        if (userStatus) {
            userStatus.textContent = 'Playing';
            userStatus.className = 'status-playing';
        }
        if (gamePauseBtn) gamePauseBtn.disabled = false;
        this.showNotification('Game started! Good luck!', 'success');
        
        // Add animation effect
        this.addAnimation('puzzle-container', 'pulse');
        
        // Update game mode specific UI
        this.updateModeSpecificUI();
        
        // Update quick mode switcher
        this.updateQuickModeSwitcher();
    },
    
    // Start normal timer
    startTimer: function() {
        if (this.timerInterval) clearInterval(this.timerInterval);
        
        this.timerInterval = setInterval(() => {
            this.sessionTime++;
            this.updateTimerDisplay();
        }, 1000);
    },
    
    // Start timed mode countdown
    startTimedMode: function() {
        if (this.timerInterval) clearInterval(this.timerInterval);
        
        this.timerInterval = setInterval(() => {
            this.timeLeft--;
            this.sessionTime++;
            
            if (this.timeLeft <= 0) {
                this.endTimedMode();
                return;
            }
            
            this.updateTimerDisplay();
        }, 1000);
    },
    
    // Update timer display based on mode
    updateTimerDisplay: function() {
        let minutes, seconds;
        
        if (this.currentMode === 'timed') {
            minutes = Math.floor(this.timeLeft / 60).toString().padStart(2, '0');
            seconds = (this.timeLeft % 60).toString().padStart(2, '0');
        } else {
            minutes = Math.floor(this.sessionTime / 60).toString().padStart(2, '0');
            seconds = (this.sessionTime % 60).toString().padStart(2, '0');
        }
        
        const timer = document.getElementById('timer');
        if (timer) {
            timer.textContent = `${minutes}:${seconds}`;
            
            // Change color when time is running low (for timed mode)
            if (this.currentMode === 'timed') {
                if (this.timeLeft < 30) {
                    timer.style.color = '#ff4444';
                    timer.classList.add('pulse-fast');
                } else if (this.timeLeft < 60) {
                    timer.style.color = '#ff9800';
                    timer.classList.add('pulse');
                } else {
                    timer.style.color = '#00ffcc';
                    timer.classList.remove('pulse', 'pulse-fast');
                }
            } else {
                timer.style.color = '#00ffcc';
            }
        }
    },
    
    // Update UI based on current game mode
    updateModeSpecificUI: function() {
        // For survival mode, show lives
        if (this.currentMode === 'survival') {
            this.showLivesDisplay();
        } else {
            // Hide lives display if not in survival mode
            const livesDisplay = document.getElementById('lives-display');
            if (livesDisplay) livesDisplay.style.display = 'none';
        }
        
        // For timed mode, show score
        if (this.currentMode === 'timed') {
            this.showScoreDisplay();
        } else {
            // Hide score display if not in timed mode
            const scoreDisplay = document.getElementById('score-display');
            if (scoreDisplay) scoreDisplay.style.display = 'none';
        }
        
        // Update mode description
        const mode = this.gameModes.find(m => m.id === this.currentMode);
        if (mode) {
            const modeDesc = document.getElementById('mode-description');
            if (modeDesc) {
                modeDesc.textContent = mode.description;
            }
        }
    },
    
    // Show lives display for survival mode
    showLivesDisplay: function() {
        let livesDisplay = document.getElementById('lives-display');
        if (!livesDisplay) {
            livesDisplay = document.createElement('div');
            livesDisplay.id = 'lives-display';
            livesDisplay.className = 'lives-display';
            
            const puzzleStats = document.querySelector('.puzzle-stats');
            if (puzzleStats) {
                puzzleStats.appendChild(livesDisplay);
            }
        }
        
        livesDisplay.style.display = 'flex';
        livesDisplay.innerHTML = `
            <span class="lives-label">Lives:</span>
            <span class="lives-count">${'â¤ï¸'.repeat(this.lives)}${'â™¡'.repeat(3 - this.lives)}</span>
        `;
    },
    
    // Show score display for timed mode
    showScoreDisplay: function() {
        let scoreDisplay = document.getElementById('score-display');
        if (!scoreDisplay) {
            scoreDisplay = document.createElement('div');
            scoreDisplay.id = 'score-display';
            scoreDisplay.className = 'score-display';
            
            const puzzleStats = document.querySelector('.puzzle-stats');
            if (puzzleStats) {
                puzzleStats.appendChild(scoreDisplay);
            }
        }
        
        scoreDisplay.style.display = 'flex';
        scoreDisplay.innerHTML = `
            <span class="score-label">Score:</span>
            <span class="score-count">${this.score}</span>
        `;
    },
    
    // End timed mode when time is up
    endTimedMode: function() {
        this.gameActive = false;
        clearInterval(this.timerInterval);
        
        const totalCorrect = this.puzzleHistory.filter(p => p.isCorrect).length;
        
        this.showNotification(`Time's up! You solved ${totalCorrect} puzzles with a score of ${this.score}!`, 'info');
        
        // Update stats
        const modeData = this.userData.neuropuzzle.modes[this.currentMode];
        if (this.score > (modeData.bestScore || 0)) {
            modeData.bestScore = this.score;
            this.saveUserData();
        }
        
        // Return to mode selection after 3 seconds
        setTimeout(() => {
            this.showModeSelection();
        }, 3000);
    },
    
    // End current session
    endSession: function() {
        this.gameActive = false;
        clearInterval(this.timerInterval);
        
        const totalCorrect = this.puzzleHistory.filter(p => p.isCorrect).length;
        const totalTime = this.sessionTime;
        
        // Calculate session stats
        const avgTime = totalCorrect > 0 ? (totalTime / totalCorrect).toFixed(1) : 0;
        const accuracy = this.puzzleHistory.length > 0 ? 
            (totalCorrect / this.puzzleHistory.length * 100).toFixed(1) : 0;
        
        this.showNotification(
            `Session ended! Solved: ${totalCorrect} | Accuracy: ${accuracy}% | Avg Time: ${avgTime}s`, 
            'info'
        );
        
        // Return to mode selection
        setTimeout(() => {
            this.showModeSelection();
        }, 1500);
    },
    
    // Generate a new puzzle
    generatePuzzle: function() {
        if (!this.currentMode) return;
        
        // Reset attempts for new puzzle
        this.currentPuzzleAttempts = 0;
        this.hintCount = 3;
        
        // Get current difficulty level
        const difficulty = this.currentDifficulty;
        
        // Select puzzle type based on mode
        let puzzleType;
        switch(this.currentMode) {
            case 'math':
                puzzleType = this.puzzleTypes[3]; // Math puzzle
                break;
            case 'creative':
                puzzleType = this.puzzleTypes[4]; // Riddle
                break;
            case 'memory':
                puzzleType = this.puzzleTypes[6]; // Memory Challenge
                break;
            case 'visual':
                puzzleType = this.puzzleTypes[5]; // Visual pattern
                break;
            case 'mixed':
                // Random puzzle type for mixed mode
                puzzleType = this.puzzleTypes[Math.floor(Math.random() * this.puzzleTypes.length)];
                break;
            default:
                // For adaptive, timed, survival - use random but weighted
                const weights = [0.2, 0.2, 0.2, 0.15, 0.15, 0.05, 0.05]; // Weights for each puzzle type
                let rand = Math.random();
                let sum = 0;
                let selectedIndex = 0;
                
                for (let i = 0; i < weights.length; i++) {
                    sum += weights[i];
                    if (rand <= sum) {
                        selectedIndex = i;
                        break;
                    }
                }
                puzzleType = this.puzzleTypes[selectedIndex];
        }
        
        // Generate puzzle
        this.currentPuzzle = puzzleType.generate(difficulty);
        
        // Update UI
        const puzzleTypeEl = document.getElementById('puzzle-type');
        const difficultyBadge = document.getElementById('difficulty-badge');
        const puzzleContent = document.getElementById('puzzle-content');
        
        if (puzzleTypeEl) {
            puzzleTypeEl.textContent = this.currentPuzzle.type;
            // Add icon
            const puzzleTypeIcon = puzzleTypeEl.querySelector('.puzzle-type-icon');
            if (!puzzleTypeIcon) {
                const icon = document.createElement('i');
                icon.className = puzzleType.icon;
                puzzleTypeEl.prepend(icon);
            }
        }
        
        const difficultyObj = this.difficulties.find(d => d.id === difficulty);
        if (difficultyBadge) {
            difficultyBadge.textContent = difficultyObj ? difficultyObj.name : 'Medium';
            difficultyBadge.style.background = difficultyObj ? difficultyObj.gradient : 'linear-gradient(135deg, #FF9800, #FFB74D)';
        }
        
        if (puzzleContent) {
            // Create engaging puzzle display
            puzzleContent.innerHTML = `
                <div class="puzzle-question-container">
                    <div class="puzzle-icon">
                        <i class="${puzzleType.icon}"></i>
                    </div>
                    <h3 class="puzzle-question">${this.currentPuzzle.question}</h3>
                    <div class="puzzle-meta">
                        <span class="puzzle-type-tag">
                            <i class="${puzzleType.icon}"></i> ${this.currentPuzzle.type}
                        </span>
                        <span class="puzzle-difficulty-tag" style="background: ${difficultyObj ? difficultyObj.gradient : 'linear-gradient(135deg, #FF9800, #FFB74D)'}">
                            <i class="${difficultyObj ? difficultyObj.icon : 'fas fa-balance-scale'}"></i> ${difficultyObj ? difficultyObj.name : 'Medium'}
                        </span>
                    </div>
                </div>
            `;
        }
        
        // Reset hint system
        const hintBtn = document.getElementById('hint-btn');
        const hintCount = document.getElementById('hint-count');
        const hintDisplay = document.getElementById('hint-display');
        const explanationDisplay = document.getElementById('explanation-display');
        
        if (hintBtn) hintBtn.disabled = false;
        if (hintCount) hintCount.textContent = this.hintCount;
        if (hintDisplay) hintDisplay.style.display = 'none';
        if (explanationDisplay) explanationDisplay.style.display = 'none';
        
        // Clear answer input and focus
        const answerInput = document.getElementById('answer-input');
        if (answerInput) {
            answerInput.value = '';
            answerInput.focus();
        }
        
        // Reset attempts display
        const attemptsCounter = document.getElementById('attempts-counter');
        if (attemptsCounter) attemptsCounter.textContent = 'Attempts: 0';
        
        // Generate quick answers
        this.generateQuickAnswers();
        
        // Show puzzle generation notification
        this.showNotification('New puzzle generated!', 'info');
        
        // Add animation effect
        this.addAnimation('puzzle-content', 'fadeIn');
    },
    
    // Generate quick answer options
    generateQuickAnswers: function() {
        const quickAnswersDiv = document.getElementById('quick-answers');
        if (!quickAnswersDiv) return;
        
        quickAnswersDiv.innerHTML = '';
        
        if (!this.currentPuzzle) return;
        
        // Create some wrong answers based on the correct one
        const correctAnswer = this.currentPuzzle.answer;
        const answers = [correctAnswer];
        
        // Add some variations for wrong answers
        if (!isNaN(correctAnswer) && correctAnswer.trim() !== '') {
            // Number puzzle
            const num = parseInt(correctAnswer);
            
            // Generate wrong answers that are mathematically related
            const wrongAnswers = [
                String(num + 1),
                String(num - 1),
                String(num * 2),
                String(Math.floor(num / 2)),
                String(num + 5),
                String(num - 5),
                String(num + 10),
                String(num - 10),
                String(num * 3),
                String(Math.floor(num / 3))
            ];
            
            // Add wrong answers, avoiding duplicates
            wrongAnswers.forEach(answer => {
                if (answers.length < 6 && !answers.includes(answer) && answer !== correctAnswer) {
                    answers.push(answer);
                }
            });
        } else {
            // Word puzzle - use similar words or common alternatives
            const word = correctAnswer.toUpperCase();
            
            // Common word associations
            const wordAssociations = {
                'CAT': ['DOG', 'BAT', 'MAT', 'HAT', 'RAT', 'CAP'],
                'DOG': ['CAT', 'LOG', 'BOG', 'FOG', 'HOG', 'DIG'],
                'RAT': ['CAT', 'BAT', 'MAT', 'FAT', 'HAT', 'PAT'],
                'COW': ['NOW', 'BOW', 'ROW', 'HOW', 'VOW', 'COY'],
                'SHORT': ['LONG', 'TALL', 'WIDE', 'THIN', 'SMALL', 'BIG'],
                'DRY': ['WET', 'TRY', 'FRY', 'CRY', 'FLY', 'DRY'],
                'SKIP': ['JUMP', 'HOP', 'RUN', 'LEAP', 'WALK', 'JOG'],
                'YELLOW': ['BLUE', 'GREEN', 'WHITE', 'BLACK', 'RED', 'PINK'],
                'NO': ['YES', 'MAYBE', 'NEVER', 'ALWAYS', 'SOMETIMES', 'OF COURSE'],
                'WHITE': ['BLACK', 'GREEN', 'BROWN', 'BLUE', 'GRAY', 'RED'],
                'SECRET': ['ANSWER', 'HIDDEN', 'PRIVATE', 'MYSTERY', 'PASSWORD', 'CODE'],
                'PIANO': ['GUITAR', 'VIOLIN', 'DRUMS', 'FLUTE', 'TRUMPET', 'HARP'],
                'ECHO': ['SOUND', 'VOICE', 'NOISE', 'MUSIC', 'WHISPER', 'SHOUT'],
                'FIRE': ['WATER', 'EARTH', 'AIR', 'FLAME', 'HEAT', 'SMOKE'],
                'STAMP': ['ENVELOPE', 'LETTER', 'POSTCARD', 'SEAL', 'MARK', 'IMPRINT'],
                'COIN': ['BILL', 'CASH', 'MONEY', 'DOLLAR', 'PENNY', 'NICKEL'],
                'TOWEL': ['CLOTH', 'RAG', 'FABRIC', 'TISSUE', 'NAP', 'BLANKET'],
                'CLOCK': ['WATCH', 'TIMER', 'ALARM', 'HOUR', 'MINUTE', 'SECOND'],
                'BOTTLE': ['JAR', 'GLASS', 'CONTAINER', 'FLASK', 'VASE', 'CUP'],
                'NEEDLE': ['PIN', 'THREAD', 'SEW', 'SHARP', 'POINT', 'THORN'],
                'MAP': ['GLOBE', 'ATLAS', 'CHART', 'PLAN', 'GUIDE', 'DIRECTION'],
                'NAME': ['TITLE', 'LABEL', 'TERM', 'DESIGNATION', 'APPELLATION', 'NICKNAME'],
                'COLD': ['FLU', 'FEVER', 'SICK', 'ILL', 'VIRUS', 'COUGH'],
                'BOOK': ['NOVEL', 'TEXT', 'MANUAL', 'GUIDE', 'VOLUME', 'PAPER'],
                'RIVER': ['STREAM', 'BROOK', 'CREEK', 'WATERWAY', 'CHANNEL', 'CANAL'],
                'COFFIN': ['CASKET', 'BOX', 'BURIAL', 'GRAVE', 'TOMB', 'URN'],
                'ROAD': ['STREET', 'PATH', 'WAY', 'HIGHWAY', 'AVENUE', 'ROUTE'],
                'FOOTSTEPS': ['FOOTPRINTS', 'TRACKS', 'STEPS', 'PATH', 'TRAIL', 'WALK'],
                'CANDLE': ['LAMP', 'LIGHT', 'TORCH', 'FLAME', 'WICK', 'WAX'],
                'GLOVE': ['MITTEN', 'HAND', 'COVER', 'PROTECTION', 'BASEBALL', 'BOXING'],
                'TELEPHONE': ['PHONE', 'CALL', 'RING', 'DIAL', 'RECEIVER', 'MOBILE'],
                'KEYBOARD': ['KEYS', 'TYPEWRITER', 'COMPUTER', 'PIANO', 'INPUT', 'CONTROL'],
                'BANK': ['MONEY', 'SAVINGS', 'LOAN', 'ACCOUNT', 'FINANCE', 'CREDIT'],
                'FUTURE': ['TOMORROW', 'LATER', 'COMING', 'AHEAD', 'DESTINY', 'FATE']
            };
            
            if (wordAssociations[word]) {
                wordAssociations[word].forEach(w => {
                    if (answers.length < 6 && !answers.includes(w)) {
                        answers.push(w);
                    }
                });
            } else {
                // Generic fallback
                const commonWords = ['YES', 'NO', 'MAYBE', 'ALWAYS', 'NEVER', 'SOMETIMES', 'OFTEN', 'RARELY'];
                commonWords.forEach(w => {
                    if (w !== word && answers.length < 6) {
                        answers.push(w);
                    }
                });
            }
        }
        
        // Fill up to 6 answers if we don't have enough
        while (answers.length < 6) {
            const randomAnswer = String(Math.floor(Math.random() * 100));
            if (!answers.includes(randomAnswer)) {
                answers.push(randomAnswer);
            }
        }
        
        // Shuffle answers
        for (let i = answers.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [answers[i], answers[j]] = [answers[j], answers[i]];
        }
        
        // Create buttons (limit to 6)
        answers.slice(0, 6).forEach(answer => {
            const btn = document.createElement('button');
            btn.className = 'quick-btn';
            btn.textContent = answer;
            btn.addEventListener('click', () => {
                const answerInput = document.getElementById('answer-input');
                if (answerInput) {
                    answerInput.value = answer;
                    answerInput.focus();
                    this.addAnimation(btn, 'pulse');
                }
            });
            quickAnswersDiv.appendChild(btn);
        });
    },
    
    // Submit answer
    submitAnswer: function() {
        if (!this.gameActive || !this.currentPuzzle) return;
        
        const answerInput = document.getElementById('answer-input');
        if (!answerInput) return;
        
        const userAnswer = answerInput.value.trim().toUpperCase();
        if (!userAnswer) {
            this.showNotification('Please enter an answer!', 'error');
            answerInput.focus();
            return;
        }
        
        const correctAnswer = this.currentPuzzle.answer.toUpperCase();
        const isCorrect = userAnswer === correctAnswer;
        
        // Increment attempts
        this.currentPuzzleAttempts++;
        
        // Record attempt
        const attempt = {
            puzzle: this.currentPuzzle.question,
            userAnswer: userAnswer,
            correctAnswer: correctAnswer,
            isCorrect: isCorrect,
            time: this.sessionTime,
            mode: this.currentMode,
            date: new Date().toISOString(),
            type: this.currentPuzzle.type,
            difficulty: this.currentPuzzle.difficulty
        };
        
        this.puzzleHistory.push(attempt);
        
        // Update attempts counter
        const attemptsCounter = document.getElementById('attempts-counter');
        if (attemptsCounter) {
            attemptsCounter.textContent = `Attempts: ${this.currentPuzzleAttempts}`;
        }
        
        // Handle survival mode lives
        if (this.currentMode === 'survival' && !isCorrect) {
            this.lives--;
            this.updateModeSpecificUI();
            
            if (this.lives <= 0) {
                this.endSurvivalMode();
                return;
            }
        }
        
        // Update combo
        if (isCorrect) {
            this.combo++;
            if (this.combo > 1) {
                this.showNotification(`Combo x${this.combo}!`, 'success');
            }
        } else {
            this.combo = 0;
        }
        
        // Update UI with animation
        if (isCorrect) {
            this.showNotification(`Correct! ${this.combo > 1 ? `Combo x${this.combo}! ` : ''}Well done! ðŸŽ‰`, 'success');
            this.addAnimation('puzzle-container', 'celebrate');
            
            // Calculate points
            const difficulty = this.difficulties.find(d => d.id === this.currentDifficulty);
            let points = 10 * difficulty.multiplier;
            
            // Add combo bonus
            if (this.combo > 1) {
                points *= this.combo;
            }
            
            // Add time bonus for timed mode
            if (this.currentMode === 'timed') {
                const timeBonus = Math.max(1, Math.floor(10 - (this.sessionTime % 60) / 6));
                points += timeBonus;
                this.score += points;
                this.updateModeSpecificUI();
            }
            
            this.updateGameStats(true, this.currentDifficulty);
            
            // Show explanation
            const explanationDisplay = document.getElementById('explanation-display');
            if (explanationDisplay) {
                explanationDisplay.innerHTML = `
                    <div class="explanation-box correct">
                        <h4><i class="fas fa-check-circle"></i> Explanation</h4>
                        <p>${this.currentPuzzle.explanation}</p>
                        ${this.currentMode === 'timed' ? `<p class="points-earned">+${points} points!</p>` : ''}
                        ${this.combo > 1 ? `<p class="combo-bonus">Combo Bonus: x${this.combo}</p>` : ''}
                    </div>
                `;
                explanationDisplay.style.display = 'block';
                this.addAnimation(explanationDisplay, 'fadeIn');
            }
            
            // Wait a moment, then generate next puzzle
            setTimeout(() => {
                this.generatePuzzle();
            }, 2500);
            
        } else {
            this.showNotification('Incorrect. Try again!', 'error');
            this.addAnimation('puzzle-container', 'shake');
            
            // Clear answer input but keep focus
            if (answerInput) {
                answerInput.value = '';
                answerInput.focus();
            }
            
            // Update game stats for incorrect attempt
            this.updateGameStats(false, this.currentDifficulty);
            
            // Show correct answer after 3 attempts
            if (this.currentPuzzleAttempts >= 3) {
                const explanationDisplay = document.getElementById('explanation-display');
                if (explanationDisplay) {
                    explanationDisplay.innerHTML = `
                        <div class="explanation-box incorrect">
                            <h4><i class="fas fa-times-circle"></i> Solution</h4>
                            <p>The correct answer is: <strong>${this.currentPuzzle.answer}</strong></p>
                            <p>${this.currentPuzzle.explanation}</p>
                        </div>
                    `;
                    explanationDisplay.style.display = 'block';
                    this.addAnimation(explanationDisplay, 'fadeIn');
                }
                
                // Wait a moment, then generate next puzzle
                setTimeout(() => {
                    this.generatePuzzle();
                }, 3000);
            }
        }
        
        // Add to recent puzzles
        this.addToRecentPuzzles(attempt);
        
        // Update history
        this.updateHistory();
    },
    
    // End survival mode when lives run out
    endSurvivalMode: function() {
        this.gameActive = false;
        clearInterval(this.timerInterval);
        
        const totalCorrect = this.puzzleHistory.filter(p => p.isCorrect).length;
        const streak = this.calculateBestStreak();
        
        this.showNotification(`Game Over! You solved ${totalCorrect} puzzles with a best streak of ${streak}!`, 'warning');
        
        // Update stats
        const modeData = this.userData.neuropuzzle.modes[this.currentMode];
        if (streak > (modeData.bestStreak || 0)) {
            modeData.bestStreak = streak;
            this.saveUserData();
        }
        
        // Return to mode selection after 3 seconds
        setTimeout(() => {
            this.showModeSelection();
        }, 3000);
    },
    
    // Calculate best streak from current session
    calculateBestStreak: function() {
        let bestStreak = 0;
        let currentStreak = 0;
        
        this.puzzleHistory.forEach(puzzle => {
            if (puzzle.isCorrect) {
                currentStreak++;
                bestStreak = Math.max(bestStreak, currentStreak);
            } else {
                currentStreak = 0;
            }
        });
        
        return bestStreak;
    },
    
    // Skip current puzzle
    skipPuzzle: function() {
        if (!this.gameActive || !this.currentPuzzle) return;
        
        // Record skip
        const attempt = {
            puzzle: this.currentPuzzle.question,
            userAnswer: 'SKIPPED',
            correctAnswer: this.currentPuzzle.answer.toUpperCase(),
            isCorrect: false,
            time: this.sessionTime,
            mode: this.currentMode,
            date: new Date().toISOString(),
            type: this.currentPuzzle.type,
            difficulty: this.currentPuzzle.difficulty
        };
        
        this.puzzleHistory.push(attempt);
        
        // Penalty for skipping
        this.userData.neuropuzzle.iqScore = Math.max(80, this.userData.neuropuzzle.iqScore - 2);
        this.combo = 0;
        
        // In survival mode, lose a life for skipping
        if (this.currentMode === 'survival') {
            this.lives--;
            this.updateModeSpecificUI();
            
            if (this.lives <= 0) {
                this.endSurvivalMode();
                return;
            }
        }
        
        this.updateGameUI();
        
        // Show notification and generate new puzzle
        this.showNotification('Puzzle skipped! Generating new one...', 'warning');
        
        setTimeout(() => {
            this.generatePuzzle();
        }, 1000);
    },
    
    // Show hint
    showHint: function() {
        if (!this.currentPuzzle || !this.currentPuzzle.hints || this.hintCount <= 0) return;
        
        const hintCountEl = document.getElementById('hint-count');
        if (!hintCountEl) return;
        
        const hints = this.currentPuzzle.hints;
        const hintIndex = 3 - this.hintCount; // Which hint to show (0, 1, or 2)
        
        if (hintIndex >= hints.length) {
            const hintBtn = document.getElementById('hint-btn');
            if (hintBtn) hintBtn.disabled = true;
            return;
        }
        
        const hint = hints[hintIndex];
        
        const hintDisplay = document.getElementById('hint-display');
        if (hintDisplay) {
            hintDisplay.innerHTML = `
                <div class="hint-box">
                    <h4><i class="fas fa-lightbulb"></i> Hint #${hintIndex + 1}</h4>
                    <p>${hint}</p>
                    <div class="hint-counter">${this.hintCount - 1} hints remaining</div>
                </div>
            `;
            hintDisplay.style.display = 'block';
            this.addAnimation(hintDisplay, 'fadeIn');
        }
        
        // Update hint count
        this.hintCount--;
        hintCountEl.textContent = this.hintCount;
        
        // Disable button if no hints left
        if (this.hintCount <= 0) {
            const hintBtn = document.getElementById('hint-btn');
            if (hintBtn) hintBtn.disabled = true;
        }
        
        // Small penalty for using hint
        this.userData.neuropuzzle.iqScore = Math.max(80, this.userData.neuropuzzle.iqScore - 1);
        this.updateGameUI();
        
        // Show notification
        this.showNotification(`Hint used! ${this.hintCount} hints remaining.`, 'info');
    },
    
    // Pause game
    pauseGame: function() {
        if (!this.gameActive || this.gamePaused) return;
        
        this.gamePaused = true;
        this.gameActive = false;
        
        if (this.timerInterval) {
            clearInterval(this.timerInterval);
            this.timerInterval = null;
        }
        
        const pauseOverlay = document.getElementById('pause-overlay');
        const userStatus = document.getElementById('user-status');
        
        if (pauseOverlay) {
            pauseOverlay.style.display = 'flex';
            this.addAnimation(pauseOverlay, 'fadeIn');
        }
        
        if (userStatus) {
            userStatus.textContent = 'Paused';
            userStatus.className = 'status-paused';
        }
        
        this.showNotification('Game paused', 'info');
    },
    
    // Resume game
    resumeGame: function() {
        if (!this.gamePaused) return;
        
        this.gamePaused = false;
        this.gameActive = true;
        
        // Restart timer based on mode
        if (this.currentMode === 'timed') {
            this.startTimedMode();
        } else {
            this.startTimer();
        }
        
        const pauseOverlay = document.getElementById('pause-overlay');
        const userStatus = document.getElementById('user-status');
        
        if (pauseOverlay) pauseOverlay.style.display = 'none';
        if (userStatus) {
            userStatus.textContent = 'Playing';
            userStatus.className = 'status-playing';
        }
        
        this.showNotification('Game resumed!', 'success');
    },
    
    // Update game stats
    updateGameStats: function(correct, difficultyLevel) {
        if (!this.userData.neuropuzzle) return;
        
        const np = this.userData.neuropuzzle;
        const modeData = np.modes[this.currentMode];
        
        // Update general stats
        if (correct) {
            np.totalSolved++;
            np.solvedToday++;
            
            // Update streak
            const today = new Date().toDateString();
            const lastPlayed = new Date(np.lastPlayed).toDateString();
            
            if (lastPlayed === today) {
                // Same day, maintain streak
            } else if (new Date(lastPlayed).getTime() === new Date(today).getTime() - 86400000) {
                // Consecutive day, increase streak
                np.streak++;
            } else {
                // Break in streak, reset
                np.streak = 1;
            }
            
            // Update IQ score based on difficulty
            const difficulty = this.difficulties.find(d => d.id === difficultyLevel);
            let iqIncrease = 2 * difficulty.multiplier;
            
            // Add combo bonus
            if (this.combo > 1) {
                iqIncrease *= this.combo;
            }
            
            np.iqScore += iqIncrease;
            
            // Increase level occasionally
            if (np.totalSolved % 5 === 0) {
                np.level = Math.min(10, np.level + 1);
            }
        } else {
            // Small penalty for incorrect answers
            np.iqScore = Math.max(80, np.iqScore - 1);
        }
        
        // Update mode-specific stats
        if (correct) {
            modeData.puzzlesSolved++;
            
            // Determine level based on difficulty
            let levelIncrease = 1;
            if (difficultyLevel === 'hard') levelIncrease = 3;
            else if (difficultyLevel === 'medium') levelIncrease = 2;
            
            const newLevel = Math.min(10, (modeData.bestLevel || 1) + levelIncrease);
            if (newLevel > (modeData.bestLevel || 1)) {
                modeData.bestLevel = newLevel;
            }
        }
        
        // Update accuracy
        const history = np.history || [];
        history.push({
            mode: this.currentMode,
            correct: correct,
            time: this.sessionTime,
            difficulty: difficultyLevel,
            date: new Date().toISOString()
        });
        
        // Keep only last 100 entries
        if (history.length > 100) history.shift();
        np.history = history;
        
        // Recalculate accuracy
        const correctCount = history.filter(h => h.correct).length;
        np.accuracy = history.length > 0 ? (correctCount / history.length) * 100 : 0;
        
        // Update mode accuracy
        const modeHistory = history.filter(h => h.mode === this.currentMode);
        const modeCorrectCount = modeHistory.filter(h => h.correct).length;
        modeData.accuracy = modeHistory.length > 0 ? (modeCorrectCount / modeHistory.length) * 100 : 0;
        
        // Save data
        np.lastPlayed = new Date().toDateString();
        this.saveUserData();
        
        // Update UI
        this.updateProgressSummary();
        this.updateGameUI();
        
        // Add animation to stats
        if (correct) {
            this.addAnimation('iq-score', 'bounce');
            this.addAnimation('streak-counter', 'bounce');
        }
    },
    
    // Add animation to element
    addAnimation: function(elementId, animationName) {
        let element;
        if (typeof elementId === 'string') {
            element = document.getElementById(elementId);
        } else {
            element = elementId; // Assume it's already a DOM element
        }
        
        if (!element) return;
        
        // Remove existing animation classes
        element.classList.remove('pulse', 'bounce', 'shake', 'fadeIn', 'celebrate', 
                                 'slideInRight', 'slideOutRight', 'slideInLeft', 'fadeIn', 'pulse-fast');
        
        // Force reflow to restart animation
        void element.offsetWidth;
        
        // Add new animation class
        element.classList.add(animationName);
        
        // Remove animation class after animation completes
        setTimeout(() => {
            element.classList.remove(animationName);
        }, 1000);
    },
    
    // Add to recent puzzles
    addToRecentPuzzles: function(attempt) {
        const recentDiv = document.getElementById('recent-puzzles');
        if (!recentDiv) return;
        
        // Remove empty state if present
        const emptyState = recentDiv.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }
        
        // Create new item
        const item = document.createElement('div');
        item.className = `recent-puzzle-item ${attempt.isCorrect ? 'correct' : 'incorrect'}`;
        item.innerHTML = `
            <div class="puzzle-result ${attempt.isCorrect ? 'correct' : 'incorrect'}">
                <i class="fas fa-${attempt.isCorrect ? 'check' : 'times'}"></i>
                <span class="puzzle-question">${attempt.puzzle.substring(0, 30)}${attempt.puzzle.length > 30 ? '...' : ''}</span>
            </div>
            <div class="puzzle-info">
                <span class="puzzle-type">${attempt.type}</span>
                <span class="puzzle-time">${new Date(attempt.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
            </div>
        `;
        
        // Add click to show details
        item.addEventListener('click', () => {
            alert(`Puzzle: ${attempt.puzzle}\nYour Answer: ${attempt.userAnswer}\nCorrect Answer: ${attempt.correctAnswer}\nStatus: ${attempt.isCorrect ? 'Correct' : 'Incorrect'}\nMode: ${this.gameModes.find(m => m.id === attempt.mode)?.name}\nDifficulty: ${attempt.difficulty}`);
        });
        
        // Add to top
        recentDiv.insertBefore(item, recentDiv.firstChild);
        
        // Limit to 5 items
        const items = recentDiv.querySelectorAll('.recent-puzzle-item');
        if (items.length > 5) {
            items[items.length - 1].remove();
        }
    },
    
    // Load history
    loadHistory: function() {
        if (!this.userData.neuropuzzle) return;
        
        const history = this.userData.neuropuzzle.history || [];
        const historyList = document.getElementById('history-list');
        if (!historyList) return;
        
        historyList.innerHTML = '';
        
        if (history.length === 0) {
            historyList.innerHTML = '<div class="empty-state">No puzzle history yet. Start playing!</div>';
            return;
        }
        
        // Show recent 20 items
        history.slice(-20).reverse().forEach(item => {
            const historyItem = document.createElement('div');
            historyItem.className = `history-item ${item.correct ? 'correct' : 'incorrect'}`;
            historyItem.innerHTML = `
                <div class="history-question">${this.getPuzzleType(item.mode)} - ${item.difficulty}</div>
                <div class="history-result">
                    <i class="fas fa-${item.correct ? 'check-circle' : 'times-circle'}"></i>
                    <span>${item.correct ? 'Correct' : 'Incorrect'}</span>
                </div>
                <div class="history-details">
                    <span><i class="far fa-clock"></i> ${new Date(item.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    <span><i class="far fa-calendar"></i> ${new Date(item.date).toLocaleDateString()}</span>
                </div>
            `;
            
            historyItem.addEventListener('click', () => {
                const modeName = this.gameModes.find(m => m.id === item.mode)?.name || item.mode;
                alert(`Mode: ${modeName}\nDifficulty: ${item.difficulty}\nTime: ${item.time} seconds\nDate: ${new Date(item.date).toLocaleString()}\nResult: ${item.correct ? 'Correct' : 'Incorrect'}`);
            });
            
            historyList.appendChild(historyItem);
        });
        
        // Update stats
        this.updateHistoryStats();
    },
    
    // Update history stats
    updateHistoryStats: function() {
        if (!this.userData.neuropuzzle) return;
        
        const history = this.userData.neuropuzzle.history || [];
        const total = history.length;
        const correct = history.filter(h => h.correct).length;
        const incorrect = total - correct;
        const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
        
        // Find best streak from history
        let bestStreak = 0;
        let currentStreak = 0;
        history.forEach(item => {
            if (item.correct) {
                currentStreak++;
                bestStreak = Math.max(bestStreak, currentStreak);
            } else {
                currentStreak = 0;
            }
        });
        
        const totalAnswersEl = document.getElementById('total-answers');
        const correctAnswersEl = document.getElementById('correct-answers');
        const incorrectAnswersEl = document.getElementById('incorrect-answers');
        const accuracyRateEl = document.getElementById('accuracy-rate');
        const bestHistoryStreakEl = document.getElementById('best-history-streak');
        
        if (totalAnswersEl) totalAnswersEl.textContent = total;
        if (correctAnswersEl) correctAnswersEl.textContent = correct;
        if (incorrectAnswersEl) incorrectAnswersEl.textContent = incorrect;
        if (accuracyRateEl) accuracyRateEl.textContent = accuracy + '%';
        if (bestHistoryStreakEl) bestHistoryStreakEl.textContent = bestStreak;
    },
    
    // Switch history tab
    switchHistoryTab: function(tabName) {
        // Update active tab
        document.querySelectorAll('.history-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
        if (activeTab) {
            activeTab.classList.add('active');
        }
        
        // Show active content
        document.querySelectorAll('.history-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        const activeContent = document.getElementById(`${tabName}-history`);
        if (activeContent) {
            activeContent.classList.add('active');
        }
        
        // Load data for the tab
        if (tabName === 'stats') {
            this.updateHistoryStats();
        } else if (tabName === 'categories') {
            this.loadCategories();
        }
    },
    
    // Load categories
    loadCategories: function() {
        const categoriesList = document.getElementById('categories-list');
        if (!categoriesList) return;
        
        categoriesList.innerHTML = '';
        
        // Group puzzles by mode
        const modeStats = {};
        this.gameModes.forEach(mode => {
            const modeData = this.userData.neuropuzzle.modes[mode.id];
            modeStats[mode.id] = {
                name: mode.name,
                solved: modeData.puzzlesSolved || 0,
                accuracy: modeData.accuracy || 0,
                bestLevel: modeData.bestLevel || 1,
                bestScore: modeData.bestScore || 0,
                bestStreak: modeData.bestStreak || 0,
                icon: mode.icon,
                color: mode.bgColor
            };
        });
        
        // Create category items
        Object.values(modeStats).forEach(stat => {
            const categoryItem = document.createElement('div');
            categoryItem.className = 'category-item';
            categoryItem.style.background = stat.color;
            categoryItem.innerHTML = `
                <div class="category-header">
                    <i class="${stat.icon}"></i>
                    <span class="category-name">${stat.name}</span>
                </div>
                <div class="category-stats">
                    <div class="stat">
                        <span class="stat-label">Solved:</span>
                        <span class="stat-value">${stat.solved}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Accuracy:</span>
                        <span class="stat-value">${stat.accuracy.toFixed(1)}%</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Best:</span>
                        <span class="stat-value">${stat.bestScore > 0 ? `Score: ${stat.bestScore}` : stat.bestStreak > 0 ? `Streak: ${stat.bestStreak}` : `Level ${stat.bestLevel}`}</span>
                    </div>
                </div>
            `;
            categoriesList.appendChild(categoryItem);
        });
    },
    
    // Load settings
    loadSettings: function() {
        const soundToggle = document.getElementById('sound-toggle');
        const animationsToggle = document.getElementById('animations-toggle');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        
        if (soundToggle && this.userData.neuropuzzle.preferences) {
            soundToggle.checked = this.userData.neuropuzzle.preferences.sound;
        }
        
        if (animationsToggle && this.userData.neuropuzzle.preferences) {
            animationsToggle.checked = this.userData.neuropuzzle.preferences.animations;
        }
        
        if (darkModeToggle && this.userData.neuropuzzle.preferences) {
            darkModeToggle.checked = this.userData.neuropuzzle.preferences.darkMode !== false;
        }
        
        // Add event listeners for toggles
        if (soundToggle) {
            soundToggle.addEventListener('change', (e) => {
                if (this.userData.neuropuzzle.preferences) {
                    this.userData.neuropuzzle.preferences.sound = e.target.checked;
                    this.saveUserData();
                    this.showNotification(`Sound ${e.target.checked ? 'enabled' : 'disabled'}`, 'info');
                }
            });
        }
        
        if (animationsToggle) {
            animationsToggle.addEventListener('change', (e) => {
                if (this.userData.neuropuzzle.preferences) {
                    this.userData.neuropuzzle.preferences.animations = e.target.checked;
                    this.saveUserData();
                    this.showNotification(`Animations ${e.target.checked ? 'enabled' : 'disabled'}`, 'info');
                }
            });
        }
        
        if (darkModeToggle) {
            darkModeToggle.addEventListener('change', (e) => {
                if (this.userData.neuropuzzle.preferences) {
                    this.userData.neuropuzzle.preferences.darkMode = e.target.checked;
                    this.saveUserData();
                    this.toggleDarkMode(e.target.checked);
                    this.showNotification(`Dark mode ${e.target.checked ? 'enabled' : 'disabled'}`, 'info');
                }
            });
        }
    },
    
    // Apply theme preferences
    applyTheme: function() {
        if (this.userData.neuropuzzle.preferences && this.userData.neuropuzzle.preferences.darkMode !== false) {
            this.toggleDarkMode(true);
        }
    },
    
    // Toggle dark mode
    toggleDarkMode: function(enabled) {
        if (enabled) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
    },
    
    // Get puzzle type from mode
    getPuzzleType: function(mode) {
        const modeObj = this.gameModes.find(m => m.id === mode);
        return modeObj ? modeObj.name : 'Unknown';
    },
    
    // Show notification
    showNotification: function(message, type = 'info') {
        const notificationArea = document.getElementById('notification-area');
        if (!notificationArea) return;
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        let icon = 'info-circle';
        if (type === 'success') icon = 'check-circle';
        if (type === 'error') icon = 'exclamation-circle';
        if (type === 'warning') icon = 'exclamation-triangle';
        
        notification.innerHTML = `
            <i class="fas fa-${icon}"></i>
            <span>${message}</span>
            <button class="notification-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        notificationArea.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode === notificationArea) {
                notification.remove();
            }
        }, 5000);
    },
    
    // Update history
    updateHistory: function() {
        // Update history display if it's open
        const historyPanel = document.getElementById('history-panel-overlay');
        if (historyPanel && historyPanel.style.display === 'block') {
            this.loadHistory();
        }
    },
    
    // Reset progress
    resetProgress: function() {
        if (!this.userData.neuropuzzle) return;
        
        if (confirm('Are you sure you want to reset all progress? This will delete all your puzzle history, stats, and achievements. This action cannot be undone.')) {
            // Reset all progress
            this.userData.neuropuzzle = {
                iqScore: 100,
                streak: 0,
                level: 1,
                totalSolved: 0,
                solvedToday: 0,
                lastPlayed: new Date().toDateString(),
                accuracy: 0,
                modes: {},
                history: [],
                preferences: {
                    difficulty: 'medium',
                    sound: true,
                    animations: true,
                    darkMode: true
                }
            };
            
            // Initialize each mode
            this.gameModes.forEach(mode => {
                this.userData.neuropuzzle.modes[mode.id] = {
                    puzzlesSolved: 0,
                    bestLevel: 1,
                    avgTime: 0,
                    accuracy: 0,
                    lastPlayed: null,
                    bestScore: 0,
                    bestStreak: 0
                };
            });
            
            this.saveUserData();
            this.updateUserDisplay();
            this.updateGameUI();
            this.initModeSelection();
            
            // Clear recent puzzles
            const recentDiv = document.getElementById('recent-puzzles');
            if (recentDiv) {
                recentDiv.innerHTML = '<div class="empty-state">No recent puzzles</div>';
            }
            
            this.showNotification('Progress reset successfully! Starting fresh!', 'success');
        }
    },
    
    // Logout function
    logout: function() {
        if (confirm('Are you sure you want to logout?')) {
            // Stop any running timers
            if (this.timerInterval) {
                clearInterval(this.timerInterval);
                this.timerInterval = null;
            }
            
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
    },
    
    // Show error message
    showError: function(message) {
        console.error('App Error:', message);
        this.showNotification(`Error: ${message}`, 'error');
    }
};

// Initialize when DOM is fully loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded');
    
    // Initialize the app
    if (window.brainTeaserApp && window.brainTeaserApp.init) {
        window.brainTeaserApp.init();
    } else {
        console.error('Brain Teaser App not found!');
        alert('App initialization failed. Please refresh the page.');
    }
});

// Fallback in case DOMContentLoaded already fired
if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(function() {
        if (window.brainTeaserApp && window.brainTeaserApp.init) {
            window.brainTeaserApp.init();
        }
    }, 100);
}

// Add global error handler
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
    console.log('An error occurred but the app will continue running.');
});

// Add resize handler for responsive adjustments
window.addEventListener('resize', function() {
    // Recreate floating particles on resize for better positioning
    if (window.brainTeaserApp && window.brainTeaserApp.createFloatingParticles) {
        window.brainTeaserApp.createFloatingParticles();
    }
});
    </script>
</body>
</html>