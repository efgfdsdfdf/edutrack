<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Companion AI | Black</title>
</head>
  <style>
    /* ===== DARK BLUE COLOR SCHEME ===== */
    :root {
      --bg-primary: #0a0f2b;
      --bg-secondary: #131b3d;
      --bg-card: #1a2452;
      --bg-hover: #242f6b;
      --accent-primary: #3a7bd5;
      --accent-secondary: #00d2ff;
      --accent-danger: #ff4757;
      --text-primary: #ffffff;
      --text-secondary: #a0a8d6;
      --text-muted: #6b7299;
      --border-color: #2a3566;
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      --shadow-light: 0 4px 15px rgba(58, 123, 213, 0.3);
      --radius: 12px;
      --radius-sm: 8px;
    }

    /* ===== GLOBAL STYLES ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

.message.user {
  align-self: flex-end;
  background: #242424;
  color: #fdfbfb;
}

.upload-menu button {
  background: transparent;
  border: none;
  color: #00ffcc;
  cursor: pointer;
  padding: 5px 10px;
}

.message.ai {
  align-self: flex-start;
  background: #171717;
  border: 1px solid #292a2a55;
}

form {
  display: flex;
  align-items: center;
  padding: 10px 15px;
  background: #0f0f0f;
  border-top: 1px solid #00ffcc33;
}

#user-input {
  flex: 1;
  padding: 12px;
  background: #1a1a1a;
  border: 1px solid #00ffcc33;
  color: #fff;
  border-radius: 10px;
  outline: none;
}

    html, body {
      height: 100%;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      line-height: 1.6;
      
    }

    /* ===== AI LAYOUT ===== */
    .ai-layout {
      display: flex;
      height: 100vh;
      width: 100%;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      width: 280px;
      background: var(--bg-card);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
      z-index: 1000;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sidebar-nav a {
      color: var(--text-secondary);
      text-decoration: none;
      padding: 12px 15px;
      border-radius: var(--radius-sm);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-nav a:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    #new-chat-btn {
      width: 100%;
      padding: 12px;
      background: var(--accent-primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    #new-chat-btn:hover {
      background: #2d68c4;
      transform: scale(1.02);
    }

    .saved-chats {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
    }

    .sidebar h3 {
      color: var(--accent-secondary);
      margin: 15px 0 10px 0;
      padding: 0 15px;
      font-size: 1.1rem;
    }

    .chat-list {
      list-style: none;
      padding: 0 15px;
    }

    .chat-list li {
      padding: 12px;
      margin-bottom: 8px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .chat-list li:hover {
      background: var(--bg-hover);
    }

    /* ===== MAIN CONTAINER ===== */
    .ai-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* ===== HEADER ===== */
    .ai-container header {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
    }

   

    .ai-container h1 {
      color: var(--accent-secondary);
      font-size: 1.5rem;
    
    }

    .ai-container h1 span {
      color: var(--text-primary);
    }

    /* ===== CHAT WINDOW ===== */
    .chat-window {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .message {
      max-width: 80%;
      padding: 15px;
      border-radius: var(--radius);
      line-height: 1.5;
      word-wrap: break-word;
    }

    .user-message {
      background: var(--accent-primary);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 5px;
    }

    .ai-message {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      align-self: flex-start;
      border-bottom-left-radius: 5px;
    }

    /* ===== LOADING INDICATOR ===== */
    .loading-indicator {
      text-align: center;
      padding: 10px;
      font-size: 1.5rem;
      display: none;
    }

    .loading-indicator.show {
      display: block;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    /* ===== CHAT FORM ===== */
    .chat-form {
      display: flex;
      padding: 15px;
      background: var(--bg-card);
      border-top: 1px solid var(--border-color);
      gap: 10px;
      align-items: flex-end;
    }

    .chat-form textarea {
      flex: 1;
      padding: 12px 15px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 1rem;
      resize: none;
      outline: none;
      font-family: 'Poppins', sans-serif;
      max-height: 120px;
      min-height: 50px;
    }

    .chat-form textarea:focus {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(58, 123, 213, 0.3);
    }

        

    .mic-btn {
      background:#000;
      color:#000;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .mic-btn:hover {
      background: var(--bg-hover);
    }

    .chat-form button[type="submit"] {
      background: var(--accent-primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .chat-form button[type="submit"]:hover {
      background: #2d68c4;
      transform: scale(1.05);
    }
/* ===== UPLOAD CONTAINER ===== */
.upload-container {
  position: fixed;
  bottom: 90px;
  right: 20px;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 10px;
  z-index: 100;
}

#uploadToggle {
  background: #000;
  color: white;
  border: none;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  font-size: 1.2rem;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: var(--shadow-light);
  z-index: 102;
}

#uploadToggle:hover {
  background: #0b0b0b;
  transform: scale(1.1);
}

.upload-menu {
  display: none; /* Hidden by default */
  flex-direction: column;
  gap: 10px;
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 10px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border-color);
  z-index: 101;
  /* Menu opens downward */
  position: absolute;
  bottom: 60px; /* Position above the toggle button */
  right: 0;
  min-width: 150px;
}

/* Show menu when active - opens downward */
.upload-container.active .upload-menu {
  display: flex;
  animation: slideDown 0.2s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.upload-menu button {
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  padding: 10px 15px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;
  width: 100%;
}

.upload-menu button:hover {
  background: var(--bg-hover);
}

/* üì∑ Compact camera preview */
#cameraStream {
  width: 200px;
  height: 140px;
  border-radius: 10px;
  border: 2px solid #00ffcc;
  object-fit: cover;
  display: none;
  position: fixed;
  top: 80px;
  right: 20px;
  z-index: 200;
  background: #000;
  box-shadow: 0 0 15px #00ffcc55;
}

/* Camera control buttons */
.camera-controls {
  position: fixed;
  bottom: 230px;
  right: 20px;
  display: none;
  gap: 10px;
  z-index: 201;
  flex-direction: column;
  align-items: center;
}

#captureBtn {
  background: #00ffcc;
  color: #000;
  border: none;
  padding: 10px 15px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
}

.send-btn {
  background: #00ffff;
  color: #000;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
}

.retake-btn {
  background: #ff0077;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
}

.send-btn:hover, .retake-btn:hover, #captureBtn:hover {
  transform: scale(1.05);
  opacity: 0.9;
}

/* Overlay to capture outside clicks */
.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  z-index: 99;
  display: none;
}

.upload-container.active ~ .overlay {
  display: block;
}
   /* Sidebar Styles */

  /* Sidebar Styles */
.sidebar {
  position: fixed;
  top: 0;
  left: -280px; /* Hidden by default */
  width: 260px;
  height: 100%;
  background: #101018;
  color: #fff;
  box-shadow: 2px 0 10px rgba(0, 0, 0, 0.6);
  padding: 20px;
  transition: left 0.3s ease;
  z-index: 999;
  overflow-y: auto;
  border-right: 2px solid #00ffcc25;
  display: flex;
  flex-direction: column;
}

.sidebar.show {
  left: 0; /* Slides in */
}

/* Sidebar header - moved to top */
.sidebar-header {
  margin-bottom: 20px;
}

.sidebar h2 {
  color: #00ffcc;
  font-size: 18px;
  border-bottom: 1px solid #00ffcc33;
  padding-bottom: 5px;
  margin-top: 0;
}

/* Main navigation - positioned in the middle */
.sidebar-nav {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin: 20px 0;
}

.sidebar a {
  display: block;
  padding: 12px 15px;
  font-size: 16px;
  text-decoration: none;
  color: #00ffaa;
  border-radius: 6px;
  transition: all 0.2s ease;
  text-align: left;
}

.sidebar a:hover {
  background: #00ffcc22;
  transform: translateX(5px);
}

/* AI section - positioned at bottom */
.ai-section {
  margin-top: auto; /* Pushes this to the bottom */
  padding-top: 20px;
  border-top: 1px solid #00ffcc33;
}

.ai-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 15px;
}

.ai-button {
  background: #00ffcc15;
  border: 1px solid #00ffcc33;
  color: #00ffcc;
  padding: 12px 15px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: center;
  font-size: 14px;
}

.ai-button:hover {
  background: #00ffcc25;
  transform: translateY(-2px);
}

/* List items */
.sidebar ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.sidebar ul li {
  padding: 12px 15px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.2s ease;
  display: flex;
  align-items: center;
  gap: 10px;
}

.sidebar ul li:hover {
  background: #00ffcc22;
  transform: translateX(5px);
}

/* Close button */
.close-btn {
  background: none;
  border: none;
  color: #00ffcc;
  font-size: 24px;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  position: absolute;
  top: 15px;
  right: 15px;
}

.close-btn:hover {
  background: #00ffcc22;
}

/* Toggle button */
.toggle-btn {
  position: fixed;
  top: 20px;
  left: 20px;
  background: #101018;
  color: #00ffcc;
  border: 1px solid #00ffcc33;
  padding: 10px 15px;
  border-radius: 4px;
  cursor: pointer;
  z-index: 998;
  transition: background 0.3s ease;
}

.toggle-btn:hover {
  background: #00ffcc22;
}

/* Responsive */
@media (max-width: 768px) {
  .sidebar {
    width: 220px;
    padding: 15px;
  }
  
  .toggle-btn {
    top: 15px;
    left: 15px;
    padding: 8px 12px;
  }
  
  .sidebar a {
    padding: 10px 12px;
    font-size: 15px;
  }
  
  .sidebar ul li {
    padding: 10px 12px;
  }
  
  .ai-button {
    padding: 10px 12px;
    font-size: 13px;
  }
}
  .toggle-btn {
    top: 15px;
    left: 15px;
    padding: 8px 10px;
  }

      
      .toggle-btn {
        display: block;
      }
      
      .ai-container {
        width: 100%;
      }
      
      .message {
        max-width: 90%;
      }
      
      .upload-container {
        bottom: 80px;
        right: 15px;
      }
    

    @media (max-width: 480px) {
      .ai-container header {
        padding: 12px 15px;
      }
      
      .ai-container h1 {
        font-size: 1.3rem;
        
      }
      
      .chat-window {
        padding: 15px;
      }
      
      .message {
        max-width: 95%;
        padding: 12px;
      }
      
      .chat-form {
        padding: 12px;
        gap: 8px;
      }
      
      .chat-form textarea {
        padding: 10px 12px;
        font-size: 0.9rem;
      }
      
      .chat-form button[type="submit"] {
        padding: 10px 15px;
        font-size: 0.9rem;
      }
      
      .mic-btn {
        padding: 10px;
      }
      
      .upload-container {
        bottom: 70px;
        right: 10px;
      }
      
      #uploadToggle {
        width: 45px;
        height: 45px;
        font-size: 1.1rem;
      }
    }

    @media (max-width: 360px) {
      .ai-container h1 {
        font-size: 1.2rem;
      }
      
      .chat-window {
        padding: 10px;
      }
      
      .message {
        padding: 10px;
        font-size: 0.9rem;
      }
      
      .chat-form {
        padding: 10px;
      }
    }

    /* ===== CUSTOM SCROLLBAR ===== */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--accent-primary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #2d68c4;
    }

    /* ===== IMAGE PREVIEW (responsive) ===== */
    .preview-box {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
      width: 100%;
      max-width: 520px; /* reasonable desktop max */
      margin: 8px 0;
      padding: 8px;
      background: rgba(255,255,255,0.01);
      border-radius: 10px;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-light);
    }

    .preview-image {
      width: 100%;
      height: auto;
      max-height: 60vh; /* avoid huge images on tall screens */
      object-fit: contain;
      border-radius: 8px;
      display: block;
    }

    .preview-actions {
      display: flex;
      gap: 8px;
      width: 100%;
      justify-content: flex-end;
    }

    /* Mobile adjustments */
    @media (max-width: 480px) {
      .preview-box {
        max-width: 92vw;
        padding: 6px;
      }
      .preview-image {
        max-height: 40vh;
      }
      .preview-actions {
        justify-content: space-between;
      }
    }

  </style>
<body>
  <div class="ai-layout">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar" aria-label="AI sidebar">
      <div class="sidebar-header">
        <nav class="sidebar-nav" aria-label="Primary">
          <a href="homepage.html">üè† Home</a>
          <a href="notes.html">üìù Notes</a>
          <a href="timetable.html">üìÖ Timetable</a>
          <a href="gpa.html">üìä GPA</a>
          <a href="profile.html">üë§ Profile</a>
        </nav>
        <div style="margin-top:12px">
          <button id="new-chat-btn" aria-controls="chat-list">üåÄ New Chat</button>
        </div>
      </div>

      <!-- container used by blackbot.js to render saved chats -->
      <u><h3>Saved Chats</h3></u>
      <div id="savedChatsContainer" class="saved-chats"></div>

      <ul id="chat-list" class="chat-list" aria-live="polite"></ul>
    </aside>
    
    <!-- Main Chat Area -->
    <div class="ai-container">
      <header>
        <button id="toggleSidebar" class="toggle-btn" aria-label="Toggle sidebar">‚ò∞</button>
        <h1>-----Student Companion <span>AI</span></h1>
      </header>

      <!-- Chat window -->
      <main id="chat-window" class="chat-window" role="region" aria-label="Chat window"></main>
      <div id="loading-indicator" class="loading-indicator" aria-hidden="true">ü§ñ</div>

      <!-- Chat form -->
      <form id="chat-form" class="chat-form" autocomplete="off">
        <button type="button" id="mic-btn" class="mic-btn" aria-label="Start voice input">üé§</button>
        <textarea id="user-input" placeholder="Ask me anything..." rows="1"></textarea>
        <button type="submit">Send</button>
      </form>
    </div>

    <input type="file" id="imageInput" accept="image/*" style="display:none" />

    <!-- Upload Section -->
    <div class="upload-container">
      <button id="uploadToggle" aria-expanded="false">‚ûï</button>
      <div id="uploadMenu" class="upload-menu" hidden>
        <button id="cameraOption">üì∏ Camera</button>
        <button id="photoOption">üñºÔ∏è Photo</button>
        <button id="fileOption">üìÅ File</button>
        <button id="notesOption">üìö Ask About Notes</button>
      </div>
      <input type="file" id="photoInput" accept="image/*" hidden />
      <input type="file" id="fileInput" accept="image/*,application/pdf" hidden />
      <video id="cameraStream" autoplay playsinline></video>

      <canvas id="photoCanvas" style="display:none;"></canvas>
    </div>
  </div>

 <script>
    // --- Elements ---
    const chatWindow = document.getElementById("chat-window");
    const chatForm = document.getElementById("chat-form");
    const userInput = document.getElementById("user-input");
    const newChatBtn = document.getElementById("new-chat-btn");
    const micBtn = document.getElementById("mic-btn");
    const loadingIndicator = document.getElementById("loading-indicator");

    const uploadToggle = document.getElementById("uploadToggle");
    const uploadMenu = document.getElementById("uploadMenu");
    const cameraOption = document.getElementById("cameraOption");
    const photoOption = document.getElementById("photoOption");
    const fileOption = document.getElementById("fileOption");
    const notesOption = document.getElementById("notesOption");
    const photoInput = document.getElementById("photoInput");
    const fileInput = document.getElementById("fileInput");
    const cameraStream = document.getElementById("cameraStream");
    const photoCanvas = document.getElementById("photoCanvas");
    const overlay = document.querySelector('.overlay');

    const sidebar = document.getElementById("sidebar");
    const toggleSidebar = document.getElementById("toggleSidebar");
    const savedChatsContainer = document.getElementById("savedChatsContainer");
    
    // Track speech recognition state
    let listeningMessage = null;
    let isListening = false;

    // --- API Configuration ---
    const baseURL = "https://openrouter.ai/api/v1";
    const apiKey = "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";
    const API_URL = `${baseURL}/chat/completions`;

    // --- User Info & Chat Memory ---
    const username = localStorage.getItem('currentUser') || localStorage.getItem('username') || 'User';
    let chatHistory = JSON.parse(localStorage.getItem(`chatHistory_${username}`) || "[]");
    let chatSessions = JSON.parse(localStorage.getItem(`chatSessions_${username}`) || "[]");
    let currentSessionId = null;

    // --- Initialize Chat ---
    window.addEventListener("DOMContentLoaded", () => {
      normalizeSessions();
      if (chatHistory.length === 0) {
        addMessage("ai", `üëã Hey ${username}, I'm Black ‚Äî your smart study assistant. How can I help you today?`);
      } else {
        chatHistory.forEach(msg => addMessage(msg.role, msg.text, msg.type));
      }
      renderSavedChats();
    });

    // --- Normalize Sessions ---
    function normalizeSessions() {
      chatSessions = (chatSessions || []).map(s => {
        if (Array.isArray(s)) {
          const firstUser = s.find(m => m.role === 'user');
          const title = firstUser ? (firstUser.text || '').slice(0,60) : ('Chat ' + new Date().toLocaleString());
          return { id: String(Date.now()) + Math.random().toString(36).slice(2,6), title, messages: s };
        }
        return s;
      });
      localStorage.setItem(`chatSessions_${username}`, JSON.stringify(chatSessions));
    }

    // --- Render Saved Chats ---
    function renderSavedChats() {
      savedChatsContainer.innerHTML = "";
      if (!chatSessions || chatSessions.length === 0) {
        savedChatsContainer.innerHTML = "<p style='padding:12px;color:var(--text-muted)'>No saved chats</p>";
        return;
      }

      chatSessions.forEach((sessionObj) => {
        const session = sessionObj.messages || sessionObj;
        const title = sessionObj.title || (session && session.length ? ((session.find(m=>m.role==='ai')?.text||session.find(m=>m.role==='user')?.text||'Untitled').slice(0,60)) : 'Untitled');

        const card = document.createElement('div');
        card.className = 'saved-chat-card';
        card.style.padding = '10px';
        card.style.margin = '8px';
        card.style.borderRadius = '8px';
        card.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))';
        card.style.cursor = 'pointer';
        card.style.display = 'flex';
        card.style.flexDirection = 'column';
        card.style.gap = '6px';

        const h = document.createElement('div');
        h.textContent = title;
        h.style.fontWeight = '600';
        h.style.color = 'var(--text-primary)';
        h.style.fontSize = '13px';

        const meta = document.createElement('div');
        meta.textContent = `${(session && session.length) || 0} messages ¬∑ ${new Date(Number(sessionObj.id) || Date.now()).toLocaleString()}`;
        meta.style.fontSize = '12px';
        meta.style.color = 'var(--text-muted)';

        card.appendChild(h);
        card.appendChild(meta);

        const del = document.createElement('button');
        del.type = 'button';
        del.textContent = 'Delete';
        del.title = 'Delete this chat';
        del.style.alignSelf = 'flex-end';
        del.style.padding = '6px 8px';
        del.style.borderRadius = '8px';
        del.style.border = 'none';
        del.style.background = 'transparent';
        del.style.color = '#ff9b9b';
        del.style.cursor = 'pointer';
        del.style.fontSize = '12px';
        del.addEventListener('click', (e) => {
          e.stopPropagation();
          if (!confirm('Delete this saved chat?')) return;
          const id = sessionObj.id || null;
          if (!id) return;
          deleteSessionById(id);
        });
        card.appendChild(del);

        card.addEventListener('click', () => {
          chatWindow.innerHTML = '';
          chatHistory = (sessionObj.messages && Array.isArray(sessionObj.messages)) ? sessionObj.messages.slice() : (Array.isArray(sessionObj) ? sessionObj.slice() : (session || []).slice());
          chatHistory.forEach(msg => addMessage(msg.role, msg.text, msg.type));
          currentSessionId = sessionObj.id || null;
        });

        savedChatsContainer.appendChild(card);
      });
    }

    // --- Delete Session ---
    function deleteSessionById(id) {
      if (!id) return;
      const idx = chatSessions.findIndex(s => String(s.id) === String(id));
      if (idx < 0) return;
      chatSessions.splice(idx, 1);
      localStorage.setItem(`chatSessions_${username}`, JSON.stringify(chatSessions));
      if (String(currentSessionId) === String(id)) {
        chatWindow.innerHTML = '';
        chatHistory = [];
        localStorage.setItem(`chatHistory_${username}`, JSON.stringify(chatHistory));
        currentSessionId = null;
        addMessage('ai', `üß† Chat deleted. Start a new chat or open another saved chat.`);
      }
      renderSavedChats();
    }

    // --- Add Message to Chat ---
    function addMessage(role, text, type = "text") {
      const msg = document.createElement("div");
      msg.classList.add("message", role);

      if (type === "image") {
        msg.innerHTML = `<p>${text}</p>`;
        chatWindow.appendChild(msg);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return;
      }

      if (role === "user") {
        msg.innerHTML = `<p>${text}</p>`;
        chatWindow.appendChild(msg);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return;
      }

      // AI typing animation with proper newline handling
      msg.innerHTML = `<p style="white-space: pre-wrap; word-wrap: break-word;"></p>`;
      chatWindow.appendChild(msg);
      const p = msg.querySelector("p");
      let i = 0;

      function typeChar() {
        if (i < text.length) {
          p.textContent += text.charAt(i);
          i++;
          chatWindow.scrollTop = chatWindow.scrollHeight;
          setTimeout(typeChar, 25);
        }
      }

      setTimeout(typeChar, 700);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // --- AI API Call ---
    async function getAIResponse(message) {
      try {
        console.log('üîÆ Sending request to OpenRouter API...');
        
        // Include notes context if available
        let systemMessage = `You are Black, an intelligent and friendly AI study assistant. You help students with academic subjects, homework, study techniques, and learning strategies. Be helpful, encouraging, and provide clear explanations. Keep responses concise but informative.`;
        
        if (window.notesContext) {
          // Check if it's the new format (object with title and content)
          if (window.notesContext.content) {
            systemMessage += `\n\nThe student is discussing the following note:\n\n**Title:** ${window.notesContext.title}\n\n**Content:**\n${window.notesContext.content}\n\nUse this note context to provide more personalized and contextual assistance. Help the student understand, analyze, or improve their note.`;
          } 
          // Keep support for old format (array of notes)
          else if (Array.isArray(window.notesContext) && window.notesContext.length > 0) {
            const notesText = formatNotesForAI(window.notesContext);
            systemMessage += `\n\nThe student has shared the following notes that may be relevant to your discussion:\n\n${notesText}\n\nUse these notes to provide more personalized and contextual assistance.`;
          }
          // Don't clear context immediately - keep it for multi-turn conversations
        }
        
        const messages = [
          {
            role: "system",
            content: systemMessage
          },
          ...chatHistory.slice(-8).map(msg => ({
            role: msg.role === 'user' ? 'user' : 'assistant',
            content: msg.text
          })),
          {
            role: "user",
            content: message
          }
        ];

        const requestBody = {
          model: "openai/gpt-3.5-turbo", // Using a model that definitely exists
          messages: messages,
          max_tokens: 800,
          temperature: 0.7,
          stream: false
        };

        console.log('üì§ Request body:', requestBody);

        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
            'HTTP-Referer': window.location.origin,
            'X-Title': 'Student Companion AI'
          },
          body: JSON.stringify(requestBody)
        });

        console.log('üì° Response status:', response.status);
        console.log('üì° Response headers:', response.headers);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('‚ùå API Error Response:', errorText);
          throw new Error(`API request failed with status ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        console.log('‚úÖ API Response data:', data);

        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
          console.error('‚ùå Invalid response format:', data);
          throw new Error('Invalid response format from API');
        }

        return data.choices[0].message.content;

      } catch (error) {
        console.error('üí• AI API Error:', error);
        throw error;
      }
    }

    // --- Chat Form Submission ---
    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const message = (userInput.value || '').trim();
      if (!message) return;

      // Check if we're waiting for note selection
      if (window.waitingForNoteSelection && window.availableNotes) {
        console.log("üîç Processing note selection...");
        
        // Try to parse as note number (1, 2, 3, etc.)
        const noteNum = parseInt(message);
        if (!isNaN(noteNum) && noteNum > 0 && noteNum <= window.availableNotes.length) {
          const selectedNote = window.availableNotes[noteNum - 1];
          console.log("‚úÖ Note selected by number:", selectedNote);
          
          // Add user message
          addMessage("user", "Analyze note: " + (selectedNote.title || "Untitled"));
          userInput.value = "";
          
          // Display the selected note
          const noteMessage = "üìñ **Analyzing your note:**\n\nüìå **Title:** " + (selectedNote.title || "Untitled") + "\n\nüìù **Content:**\n\n" + selectedNote.content;
          addMessage("ai", noteMessage);
          
          // Store the note content as context for AI responses
          window.notesContext = {
            title: selectedNote.title || "Untitled",
            content: selectedNote.content,
            timestamp: new Date().toISOString()
          };
          
          window.waitingForNoteSelection = false;
          addMessage("ai", "üí° What would you like me to help you with regarding this note? You can ask me to summarize, explain, improve, or analyze it!");
          return;
        } 
        
        // Try to match by note title
        const matchedNote = window.availableNotes.find(note => 
          note.title && note.title.toLowerCase().includes(message.toLowerCase())
        );
        
        if (matchedNote) {
          console.log("‚úÖ Note selected by title:", matchedNote);
          
          // Add user message
          addMessage("user", "Analyze note: " + (matchedNote.title || "Untitled"));
          userInput.value = "";
          
          // Display the selected note
          const noteMessage = "üìñ **Analyzing your note:**\n\nüìå **Title:** " + (matchedNote.title || "Untitled") + "\n\nüìù **Content:**\n\n" + matchedNote.content;
          addMessage("ai", noteMessage);
          
          // Store the note content as context for AI responses
          window.notesContext = {
            title: matchedNote.title || "Untitled",
            content: matchedNote.content,
            timestamp: new Date().toISOString()
          };
          
          window.waitingForNoteSelection = false;
          addMessage("ai", "üí° What would you like me to help you with regarding this note? You can ask me to summarize, explain, improve, or analyze it!");
          return;
        }
        
        // If no match found, show error and list again
        addMessage("user", message);
        addMessage("ai", "‚ùå I couldn't find that note. Please enter a valid number (1, 2, 3...) or type the note title name:");
        
        // Show the list again
        let notesListHTML = "üìö **Available notes:**\n\n";
        window.availableNotes.forEach((note, idx) => {
          notesListHTML += (idx + 1) + ". **" + (note.title || "Untitled") + "**\n";
        });
        addMessage("ai", notesListHTML);
        userInput.value = "";
        return;
      }

      // Normal chat flow - Add user message immediately
      addMessage("user", message);
      userInput.value = "";
      
      // Save to history
      chatHistory.push({ role: "user", text: message });
      localStorage.setItem(`chatHistory_${username}`, JSON.stringify(chatHistory));

      // Show loading
      loadingIndicator.style.display = "block";

      try {
        // Get AI response
        const aiResponse = await getAIResponse(message);
        
        // Add AI response
        addMessage("ai", aiResponse);
        chatHistory.push({ role: "ai", text: aiResponse });
        localStorage.setItem(`chatHistory_${username}`, JSON.stringify(chatHistory));

        // Auto-save session
        await autoSaveSession(aiResponse);
        renderSavedChats();

      } catch (error) {
        console.error('üí¨ Chat error:', error);
        
        let errorMsg = '‚ö†Ô∏è Sorry, I encountered an error. Please try again.';
        
        if (error.message.includes('Failed to fetch')) {
          errorMsg = '‚ö†Ô∏è Network error. Please check your internet connection and try again.';
        } else if (error.message.includes('401') || error.message.includes('403')) {
          errorMsg = '‚ö†Ô∏è API authentication failed. Please check your API key.';
        } else if (error.message.includes('429')) {
          errorMsg = '‚ö†Ô∏è Rate limit exceeded. Please wait a moment and try again.';
        } else if (error.message.includes('500')) {
          errorMsg = '‚ö†Ô∏è Server error. Please try again later.';
        }
        
        const errorElement = document.createElement("div");
        errorElement.classList.add("message", "ai", "error-message");
        errorElement.innerHTML = `<p>${errorMsg}</p>`;
        chatWindow.appendChild(errorElement);
        
        chatHistory.push({ role: "ai", text: errorMsg });
        localStorage.setItem(`chatHistory_${username}`, JSON.stringify(chatHistory));
        
        chatWindow.scrollTop = chatWindow.scrollHeight;
      } finally {
        loadingIndicator.style.display = "none";
      }
    });

    // --- Auto Save Session ---
    async function autoSaveSession(lastAiReply) {
      try {
        normalizeSessions();
      } catch (e) { /* ignore */ }

      const now = Date.now();
      const messagesCopy = (chatHistory || []).slice();

      let title = '';
      if (lastAiReply) {
        title = (lastAiReply.split(/\.|\n|\?|!/)[0] || '').trim();
      }
      if (!title) {
        const firstUser = messagesCopy.find(m => m.role === 'user');
        title = (firstUser && firstUser.text) ? firstUser.text.slice(0,80) : '';
      }
      if (!title) title = 'Untitled';
      if (title.length > 80) title = title.slice(0,77) + '...';

      if (currentSessionId) {
        const idx = chatSessions.findIndex(s => String(s.id) === String(currentSessionId));
        if (idx >= 0) {
          chatSessions[idx].messages = messagesCopy;
          if (!chatSessions[idx].title || chatSessions[idx].title === '' || chatSessions[idx].title.startsWith('Chat')) {
            chatSessions[idx].title = title;
          }
        } else {
          const newSession = { id: String(now), title, messages: messagesCopy };
          chatSessions.unshift(newSession);
          currentSessionId = newSession.id;
        }
      } else {
        const sig = JSON.stringify(messagesCopy);
        const existingIdx = chatSessions.findIndex(s => {
          const msgs = s.messages || s;
          try { return JSON.stringify(msgs) === sig; } catch (e) { return false; }
        });
        if (existingIdx >= 0) {
          const existing = chatSessions.splice(existingIdx, 1)[0];
          existing.messages = messagesCopy;
          if (!existing.title || existing.title.startsWith('Chat')) existing.title = title;
          chatSessions.unshift(existing);
          currentSessionId = existing.id;
        } else {
          const newSession = { id: String(now), title, messages: messagesCopy };
          chatSessions.unshift(newSession);
          currentSessionId = newSession.id;
        }
      }

      localStorage.setItem(`chatSessions_${username}`, JSON.stringify(chatSessions));
    }

    // --- New Chat ---
    newChatBtn.addEventListener("click", () => {
      try {
        if (chatHistory && chatHistory.length > 0) {
          const messagesCopy = chatHistory.slice();
          const sig = JSON.stringify(messagesCopy);
          const existingIdx = chatSessions.findIndex(s => {
            const msgs = s.messages || s;
            try { return JSON.stringify(msgs) === sig; } catch (e) { return false; }
          });
          if (existingIdx >= 0) {
            const existing = chatSessions.splice(existingIdx, 1)[0];
            chatSessions.unshift(existing);
            currentSessionId = existing.id || null;
          } else {
            const firstUser = chatHistory.find(m => m.role === 'user');
            const title = firstUser ? (firstUser.text || '').slice(0,80) : ('Chat ' + new Date().toLocaleString());
            const sessionObj = { id: String(Date.now()), title, messages: messagesCopy };
            chatSessions.unshift(sessionObj);
            currentSessionId = sessionObj.id;
          }
          localStorage.setItem(`chatSessions_${username}`, JSON.stringify(chatSessions));
        }
      } catch (e) { console.warn('save session failed', e); }

      chatWindow.innerHTML = "";
      chatHistory = [];
      currentSessionId = null;
      localStorage.setItem(`chatHistory_${username}`, JSON.stringify(chatHistory));
      addMessage("ai", `üß† New chat started, ${username}. What would you like to discuss today?`);
      renderSavedChats();
    });

    // --- Upload Toggle ---
    uploadToggle.addEventListener("click", () => {
      uploadMenu.style.display = uploadMenu.style.display === "flex" ? "none" : "flex";
    });

    // --- Photo Upload ---
    photoOption.addEventListener("click", () => {
      uploadMenu.style.display = "none";
      photoInput.click();
    });

    photoInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) previewImageBeforeSend(file);
    });

    // --- File Upload ---
    fileOption.addEventListener("click", () => {
      uploadMenu.style.display = "none";
      fileInput.click();
    });

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) sendFileToAI(file);
    });

    // --- Ask About Notes ---
    notesOption.addEventListener("click", () => {
      console.log("üéØ Notes button clicked!");
      uploadMenu.style.display = "none";
      
      const notes = getSavedNotes();
      console.log("üìä Notes found:", notes);
      
      if (notes.length === 0) {
        addMessage("ai", "üìö You don't have any saved notes yet. Go to the Notes section to create some!");
        return;
      }
      
      // Create a list of notes for user to select from
      let notesListHTML = "üìö **Select a note to analyze:**\n\n";
      notes.forEach((note, idx) => {
        const noteNum = idx + 1;
        notesListHTML += noteNum + ". **" + (note.title || "Untitled") + "**\n";
      });
      notesListHTML += "\nType the number (1, 2, 3, etc.) to select a note, or ask me about a specific note by name!";
      
      addMessage("ai", notesListHTML);
      
      // Store notes in window for selection
      window.availableNotes = notes;
      window.waitingForNoteSelection = true;
      
      console.log("‚úÖ Notes list displayed, waiting for selection");
    });

    // --- Camera Capture ---
    let cameraActive = false;
    let cameraStreamObj = null;

    cameraOption.addEventListener("click", async () => {
      if (cameraActive && cameraStreamObj) {
        const ctx = photoCanvas.getContext("2d");
        photoCanvas.width = cameraStream.videoWidth;
        photoCanvas.height = cameraStream.videoHeight;
        ctx.drawImage(cameraStream, 0, 0);

        cameraStreamObj.getTracks().forEach(track => track.stop());
        cameraStream.style.display = "none";
        cameraActive = false;

        photoCanvas.toBlob((blob) => previewImageBeforeSend(blob), "image/jpeg");
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        cameraStreamObj = stream;
        cameraStream.srcObject = stream;
        cameraStream.style.display = "block";
        cameraActive = true;

        addMessage("ai", "üì∏ Camera active ‚Äî click again to capture photo.");
      } catch (err) {
        alert("‚ùå Camera access denied or unavailable.");
        cameraActive = false;
      }
    });

    // --- Preview Image ---
    function previewImageBeforeSend(fileOrBlob) {
      // Resize image for preview and sending to keep it portable on phones
      const imgURL = URL.createObjectURL(fileOrBlob);
      const previewDiv = document.createElement("div");
      previewDiv.classList.add("preview-box");

      const img = document.createElement('img');
      img.className = 'preview-image';
      img.src = imgURL;

      const actions = document.createElement('div');
      actions.className = 'preview-actions';
      const sendBtn = document.createElement('button');
      sendBtn.type = 'button';
      sendBtn.id = 'sendImgBtn';
      sendBtn.className = 'send-btn';
      sendBtn.textContent = 'Send';
      const retakeBtn = document.createElement('button');
      retakeBtn.type = 'button';
      retakeBtn.id = 'retakeImgBtn';
      retakeBtn.className = 'retake-btn';
      retakeBtn.textContent = 'Retake';
      actions.appendChild(sendBtn);
      actions.appendChild(retakeBtn);

      previewDiv.appendChild(img);
      previewDiv.appendChild(actions);
      chatWindow.appendChild(previewDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      // Default: use original blob unless resized
      let blobForSend = fileOrBlob;

      // Resize image on load to a sensible max width for mobile (keep aspect ratio)
      img.onload = () => {
        try {
          const MAX_WIDTH = 1000; // px - reasonable max for desktop
          const MAX_MOBILE_WIDTH = 800; // for mobile resizing target
          const maxTarget = Math.min(MAX_WIDTH, window.innerWidth * 0.9, MAX_MOBILE_WIDTH);
          const iw = img.naturalWidth;
          const ih = img.naturalHeight;
          let targetW = iw;
          let targetH = ih;

          if (iw > maxTarget) {
            targetW = maxTarget;
            targetH = Math.round((maxTarget / iw) * ih);
          }

          // If image is already small, no need to resize
          if (targetW < iw || targetH < ih) {
            const canvas = document.createElement('canvas');
            canvas.width = targetW;
            canvas.height = targetH;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#000';
            ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.drawImage(img, 0, 0, targetW, targetH);

            // Use JPEG at 0.85 to reduce size while keeping quality
            canvas.toBlob((b) => {
              if (b) {
                blobForSend = b;
                // update preview image to resized version
                const resizedURL = URL.createObjectURL(b);
                img.src = resizedURL;
                // revoke original object URL to free memory
                URL.revokeObjectURL(imgURL);
              }
            }, 'image/jpeg', 0.85);
          }
        } catch (err) {
          console.warn('Image resize failed, using original file:', err);
        }
      };

      sendBtn.addEventListener('click', () => {
        sendImageToAI(blobForSend);
        previewDiv.remove();
      });

      retakeBtn.addEventListener('click', () => {
        previewDiv.remove();
      });
    }

    // --- Send Image to AI ---
    async function sendImageToAI(fileOrBlob) {
      addMessage("user", "üñºÔ∏è Sent an image...", "image");

      try {
        addMessage("ai", "üì∏ Image received. I can see your image but detailed analysis is not available in this version.");
        
        chatHistory.push({ role: "user", text: "üñºÔ∏è Sent an image...", type: "image" });
        chatHistory.push({ role: "ai", text: "üì∏ Image received and processed." });
        localStorage.setItem(`chatHistory_${username}`, JSON.stringify(chatHistory));
        renderSavedChats();
      } catch (err) {
        addMessage("ai", "‚ö†Ô∏è Error processing image.");
        console.error(err);
      }
    }

    // --- Send File to AI ---
    async function sendFileToAI(file) {
      addMessage("user", `üìé Uploaded: ${file.name}`);

      try {
        addMessage("ai", `üìÑ File "${file.name}" received. I can help you with text-based files.`);
        
        chatHistory.push({ role: "user", text: `üìé Uploaded: ${file.name}` });
        chatHistory.push({ role: "ai", text: `üìÑ File "${file.name}" received.` });
        localStorage.setItem(`chatHistory_${username}`, JSON.stringify(chatHistory));
        renderSavedChats();
      } catch (err) {
        addMessage("ai", "‚ö†Ô∏è Error processing file.");
        console.error(err);
      }
    }

    // --- Sidebar Toggle ---
    if (toggleSidebar && sidebar) {
      toggleSidebar.addEventListener("click", (e) => {
        e.stopPropagation();
        if (window.innerWidth <= 700) {
          sidebar.classList.toggle("show");
        } else {
          sidebar.classList.toggle("collapsed");
        }
      });

      document.addEventListener("click", (e) => {
        try {
          if (!sidebar || !toggleSidebar) return;
          if (!sidebar.contains(e.target) && !toggleSidebar.contains(e.target)) {
            if (window.innerWidth <= 700) {
              sidebar.classList.remove('show');
            } else {
              sidebar.classList.add('collapsed');
            }
          }
        } catch (err) { /* ignore */ }
      });

      window.addEventListener("resize", () => {
        if (window.innerWidth > 700) {
          sidebar.classList.remove("show");
        }
      });
    }

    // --- Expand chat input ---
    userInput.addEventListener("input", () => {
      userInput.style.height = "auto";
      userInput.style.height = userInput.scrollHeight + "px";
    });

    // --- Microphone Input (Basic Implementation) ---
    micBtn.addEventListener("click", () => {
      if (!("webkitSpeechRecognition" in window)) {
        alert("Speech recognition not supported in this browser.");
        return;
      }
      
      const recognition = new webkitSpeechRecognition();
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.continuous = false;

      recognition.onstart = () => {
        listeningMessage = document.createElement("div");
        listeningMessage.classList.add("message", "ai");
        listeningMessage.innerHTML = `<p>üé§ Listening...</p>`;
        chatWindow.appendChild(listeningMessage);
        isListening = true;
        chatWindow.scrollTop = chatWindow.scrollHeight;
      };

      recognition.onresult = (e) => {
        const transcript = e.results[0][0].transcript;
        userInput.value = transcript;
        
        // Remove "Listening" message and show "AI listened"
        if (listeningMessage) {
          listeningMessage.innerHTML = `<p>‚úÖ AI listened!</p>`;
        }
      };

      recognition.onerror = (e) => {
        if (listeningMessage) {
          listeningMessage.innerHTML = `<p>‚ö†Ô∏è Speech recognition error.</p>`;
        }
      };

      recognition.onend = () => {
        isListening = false;
        console.log("Speech recognition ended.");
      };

      recognition.start();
    });

    // --- Overlay for upload menu ---
    overlay.addEventListener('click', () => {
      uploadMenu.style.display = 'none';
    });

    uploadToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      uploadMenu.style.display = uploadMenu.style.display === 'flex' ? 'none' : 'flex';
    });

    document.addEventListener('click', (e) => {
      if (!uploadToggle.contains(e.target) && !uploadMenu.contains(e.target)) {
        uploadMenu.style.display = 'none';
      }
    });

    // --- Load Notes and Connect to AI ---
    function getSavedNotes() {
      try {
        const currentUser = localStorage.getItem('currentUser');
        console.log("üë§ Current user:", currentUser);
        
        let notes = [];
        
        // Try to get notes from users object (logged-in user)
        if (currentUser) {
          try {
            const usersData = localStorage.getItem('users');
            console.log("üì¶ Users data exists:", !!usersData);
            
            if (usersData) {
              const users = JSON.parse(usersData);
              console.log("üë• All users:", Object.keys(users));
              
              if (users[currentUser]) {
                console.log("‚úì User found:", currentUser);
                console.log("üìã User object keys:", Object.keys(users[currentUser]));
                
                if (Array.isArray(users[currentUser].notes)) {
                  notes = users[currentUser].notes;
                  console.log("‚úÖ Got notes from user object:", notes.length, "notes");
                } else {
                  console.log("‚ö†Ô∏è notes is not an array:", typeof users[currentUser].notes);
                }
              } else {
                console.log("‚ùå User not found in users object");
              }
            }
          } catch (e) {
            console.error("‚ùå Error parsing users:", e);
          }
        }
        
        // If no notes found, try global notes storage
        if (notes.length === 0) {
          try {
            const globalNotes = localStorage.getItem('notes');
            if (globalNotes) {
              notes = JSON.parse(globalNotes);
              console.log("‚úÖ Got notes from global storage:", notes.length, "notes");
            }
          } catch (e) {
            console.error("‚ùå Error parsing global notes:", e);
          }
        }
        
        console.log("üéØ Final notes array:", notes);
        return notes;
      } catch (err) {
        console.error("‚ùå Fatal error in getSavedNotes:", err);
        return [];
      }
    }

    function formatNotesForAI(notes) {
      if (!notes || notes.length === 0) {
        return "No notes found.";
      }
      
      return notes.map((note, idx) => {
        return `**Note ${idx + 1}: ${note.title || 'Untitled'}**\n${note.content || '(empty)'}`;
      }).join('\n\n---\n\n');
    }
  </script>
</body>
</html>
